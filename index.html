<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>APP store ¬∑ Èü≥‰πê(ÂèåÊ∫ê) ¬∑ ‰∏âË°åÊ≠åËØç</title>
    <style>
        /* ===== Âü∫Á°ÄÊ†∑Âºè (ÂÆåÂÖ®‰øùÁïô) ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #0a0a0c;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 16px 12px 0px;
            color: #ffffff;
        }

        .container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding-bottom: 100px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 8px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .logo-icon.ios-theme {
            background: #1e88e5;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
        }

        .logo-icon.android-theme {
            background: #4CAF50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .logo-text {
            font-size: 22px;
            font-weight: 600;
            color: #fff;
        }

        .search-bar {
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            border-radius: 30px;
            padding: 6px 6px 6px 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 4px;
        }

        .search-bar span {
            font-size: 18px;
            color: #888;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            flex: 1;
            outline: none;
            padding: 8px 0;
        }

        .search-bar input::placeholder {
            color: #555;
        }

        .search-cancel {
            background: #2c2c2e;
            border: none;
            color: #aaa;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            border: 0.5px solid #3a3a3c;
        }

        .search-cancel:active {
            background: #3a3a3c;
            color: white;
        }

        .apps-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            margin-top: 4px;
            padding-bottom: 20px;
        }

        .app-card {
            background: #1c1c1e;
            border-radius: 24px;
            padding: 16px;
            border: 1px solid #2c2c2e;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s;
        }

        .app-card:active {
            background: #2c2c2e;
            transform: scale(0.99);
        }

        .app-icon {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: #2c2c2e;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 38px;
            border: 2px solid #3a3a3c;
            color: #aaa;
        }

        .app-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .app-name {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-platform {
            font-size: 12px;
            background: #2c2c2e;
            padding: 3px 10px;
            border-radius: 20px;
            color: #aaa;
            display: inline-block;
            border: 0.5px solid #3a3a3c;
        }

        .app-url-preview {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
            margin-bottom: 8px;
        }

        .download-badge {
            color: white;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            background: #1e88e5;
            box-shadow: 0 2px 8px rgba(30, 136, 229, 0.3);
        }
        .download-badge.ios-theme { background: #1e88e5; }
        .download-badge.android-theme { background: #4CAF50; }

        .music-section { width: 100%; }

        .daily-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0 12px;
        }
        .daily-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
        }

        .refresh-daily {
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            color: #aaa;
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .refresh-daily:active {
            background: #3a3a3c;
            color: white;
        }
        .refresh-daily.ios-theme:active {
            background: #1e88e5;
            color: white;
            border-color: #1e88e5;
        }
        .refresh-daily.android-theme:active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .music-item {
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .music-item:active {
            background: #2c2c2e;
            transform: scale(0.99);
        }

        .music-cover {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #888;
            overflow: hidden;
            flex-shrink: 0;
        }

        .music-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .music-info {
            flex: 1;
            min-width: 0;
        }

        .music-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-artist {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-album {
            font-size: 11px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .api-status {
            font-size: 11px;
            color: #888;
            margin-left: 8px;
            padding: 2px 8px;
            background: #2c2c2e;
            border-radius: 20px;
            display: inline-block;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #888;
            background: #1c1c1e;
            border-radius: 16px;
            border: 1px solid #2c2c2e;
            margin-top: 20px;
        }
        .loading::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #555;
            background: #1c1c1e;
            border-radius: 16px;
            border: 2px dashed #2c2c2e;
            margin-top: 20px;
            font-size: 15px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            border-radius: 40px;
        }

        .page-btn {
            background: transparent;
            border: none;
            color: #888;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .page-btn.active { background: #1e88e5; color: white; }
        .page-btn:active { background: #2c2c2e; }
        .page-info { color: #888; font-size: 14px; }

        /* ===== Ê≠åËØçÊ†∑Âºè - ‰∏âË°åÊòæÁ§∫ ===== */
        .floating-player {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 400px;
            background: rgba(28, 28, 30, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 12px;
            z-index: 150;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            display: none;
        }
        .floating-player.show { display: block; }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .now-playing-info { flex: 1; }
        .now-playing-title { font-size: 14px; font-weight: 600; color: white; }
        .now-playing-artist { font-size: 11px; color: #888; }
        .close-player {
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 20px;
            cursor: pointer;
            padding: 0 8px;
        }
        .close-player:active { color: white; }

        .lyrics-scroll-container {
            height: 96px;
            overflow-y: auto;
            margin: 6px 0 8px;
            padding: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid #3a3a3c;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            line-height: 32px;
        }

        .lyric-line {
            text-align: center;
            padding: 0;
            color: #aaa;
            font-size: 12px;
            transition: all 0.2s;
            line-height: 32px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            height: 32px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .lyric-line:last-child { border-bottom: none; }

        .lyric-line.active.ios-theme {
            color: #1e88e5;
            font-size: 14px;
            font-weight: 600;
        }
        
        .lyric-line.active.android-theme {
            color: #4CAF50;
            font-size: 14px;
            font-weight: 600;
        }

        .no-lyric {
            text-align: center;
            padding: 0;
            color: #888;
            font-size: 13px;
            font-style: italic;
            line-height: 96px;
        }

        .audio-wrapper audio {
            width: 100%;
            height: 40px;
            border-radius: 20px;
            background: #2c2c2e;
        }

        .bottom-nav {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 360px;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 6px 4px;
            z-index: 100;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #8e8e93;
            font-size: 11px;
            font-weight: 500;
            padding: 6px 0;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            width: 60px;
            gap: 2px;
        }
        .nav-item.active { color: white; }
        .nav-item.active.ios-theme { background: rgba(30, 136, 229, 0.2); }
        .nav-item.active.android-theme { background: rgba(76, 175, 80, 0.2); }
        .nav-item i { font-size: 20px; font-style: normal; }

        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            padding: 16px;
        }
        .modal.show { opacity: 1; pointer-events: auto; }

        .version-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 14px 28px;
            border-radius: 40px;
            font-size: 16px;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border: 1px solid #555;
        }
        .version-toast.show { opacity: 1; }

        #music-results-container { display: none; }
        #music-results-container.has-results { display: block; }

        .search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0 12px;
        }
        .search-header .search-title {
            font-size: 16px;
            font-weight: 500;
            color: #aaa;
        }
        .hidden { display: none !important; }

        .comic-iframe-container {
            width: 100%;
            height: 460px;
            background: #1c1c1e;
            border-radius: 24px;
            border: 2px solid #2c2c2e;
            overflow: hidden;
            margin: 16px 0 20px;
            position: relative;
        }
        .comic-iframe-container iframe {
            width: 100%;
            height: 600px;
            border: none;
            background: white;
            transform: translateY(-80px);
            pointer-events: auto;
        }
        .comic-search-tip {
            font-size: 12px;
            color: #aaa;
            text-align: center;
            padding: 6px;
            background: #2c2c2e;
            border-radius: 20px;
            margin-bottom: 8px;
            border: 1px solid #3a3a3c;
        }
        .comic-search-tip span { color: #1e88e5; font-weight: 500; }

        /* ===== ÂÖ®Â±èÊ∏∏ÊàèÊµÆÂ±Ç (ËΩªËß¶Ë∑≥Ë∑É,ÂÖ≥Èó≠ÈáçÁΩÆ) ===== */
        .game-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: #000;
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            touch-action: none;  /* Èò≤Ê≠¢Ëß¶Êë∏Êó∂È°µÈù¢ÊªöÂä® */
        }
        .game-overlay.show { display: flex; }

        .game-header {
            width: 100%;
            max-width: 800px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #1e1e1e;
            padding: 12px 24px;
            border-radius: 60px;
            margin-bottom: 16px;
            border: 1px solid #3a3a3c;
        }
        .game-title { color: #ffd966; font-size: 1.8rem; font-weight: bold; letter-spacing: 2px; }
        .game-close { background: #3a3a3c; border: none; color: white; font-size: 32px; width: 60px; height: 60px; border-radius: 40px; cursor: pointer; line-height: 1; }

        .game-canvas-wrapper {
            background: #1a2a32;
            border-radius: 28px;
            border: 3px solid #2c3e50;
            overflow: hidden;
            width: 100%;
            max-width: 1000px;
            aspect-ratio: 800 / 300;
        }
        canvas { display: block; width: 100%; height: 100%; image-rendering: crisp-edges; background: #fefefe; }
    </style>
</head>
<body>
    <div class="version-toast" id="versionToast">üéµ ÂèåÊ∫êÈü≥‰πê ¬∑ ‰∏âË°åÊ≠åËØç</div>

    <div class="container">
        <div class="header">
            <div class="logo-area">
                <div class="logo-icon" id="logoIcon">C</div>
                <div class="logo-text">APP store</div>
            </div>
        </div>

        <div class="search-bar" id="searchBar">
            <span>üîç</span>
            <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢ÂΩìÂâçÂàÜÂå∫..." autocomplete="off">
            <button class="search-cancel" id="searchCancelBtn">ÂèñÊ∂à</button>
        </div>

        <div class="apps-grid" id="appsGrid"></div>
    </div>

    <div class="bottom-nav" id="bottomNav">
        <button class="nav-item active" data-cat="apps"><i>üì±</i> Â∫îÁî®</button>
        <button class="nav-item" data-cat="games"><i>üéÆ</i> Ê∏∏Êàè</button>
        <button class="nav-item" data-cat="movies"><i>üé¨</i> ÁîµÂΩ±</button>
        <button class="nav-item" data-cat="music"><i>üéµ</i> Èü≥‰πê</button>
        <button class="nav-item" data-cat="books"><i>üìö</i> Âõæ‰π¶</button>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÂºπÁ™ó (‰øùÁïôÂÆåÂÖ®‰∏çÂèò) -->
    <div class="modal" id="appModal">
        <div class="modal-card">
            <h2 id="modalTitle">Ê∑ªÂä†Â∫îÁî®Âà∞Êî∂Ëóè</h2>
            <div class="input-field"><label>Â∫îÁî®ÂêçÁß∞</label><input type="text" id="appName" placeholder="‰æãÂ¶Ç: ÊàëÁöÑÂ∫îÁî®"></div>
            <div class="input-field">
                <label>‰∏ãËΩΩÈìæÊé•</label>
                <div class="url-input-row"><input type="url" id="appUrl" placeholder="https://loadly.io/..." value="https://loadly.io/"><button class="fetch-btn" id="fetchInfoBtn">Ëé∑Âèñ</button></div>
                <div id="fetchStatus" class="fetch-status"></div>
            </div>
            <div class="input-field">
                <label>Âπ≥Âè∞</label>
                <div class="platform-selector" id="platformSelector">
                    <div class="platform-option selected" data-platform="ios"><i>üçé</i> iOS</div>
                    <div class="platform-option" data-platform="android"><i>ü§ñ</i> Android</div>
                </div>
                <input type="hidden" id="appPlatform" value="ios">
            </div>
            <div class="input-field">
                <label>ÂàÜÁ±ª</label>
                <select id="appCategory">
                    <option value="apps">üì± Â∫îÁî®</option>
                    <option value="games">üéÆ Ê∏∏Êàè</option>
                    <option value="movies">üé¨ ÁîµÂΩ±</option>
                    <option value="music">üéµ Èü≥‰πê</option>
                    <option value="books">üìö Âõæ‰π¶</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelModalBtn">ÂèñÊ∂à</button>
                <button class="modal-btn primary" id="saveAppBtn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÊÇ¨ÊµÆÊí≠ÊîæÂô® - ‰∏âË°åÊ≠åËØç (ÂÆåÂÖ®‰øùÁïô) -->
    <div class="floating-player" id="floatingPlayer">
        <div class="player-header">
            <div class="now-playing-info">
                <div class="now-playing-title" id="playerTitle">ËØ∑ÈÄâÊã©Ê≠åÊõ≤</div>
                <div class="now-playing-artist" id="playerArtist"></div>
            </div>
            <button class="close-player" id="closePlayerBtn">‚úï</button>
        </div>
        <div class="lyrics-scroll-container" id="lyricsContainer">
            <div class="no-lyric">ÊöÇÊó†Ê≠åËØç</div>
        </div>
        <div class="audio-wrapper">
            <audio id="audioPlayer" controls controlslist="nodownload"></audio>
        </div>
    </div>

    <!-- ÂÖ®Â±èÊ∏∏ÊàèÊµÆÂ±Ç (ÂΩ©Ëõã) -->
    <div class="game-overlay" id="gameOverlay">
        <div class="game-header">
            <span class="game-title">ü¶ñ ÂÉèÁ¥†ÂÜ≤Âà∫</span>
            <button class="game-close" id="closeGameBtn">‚úï</button>
        </div>
        <div class="game-canvas-wrapper">
            <canvas id="gameCanvas" width="800" height="300"></canvas>
        </div>
    </div>

    <script>
        (function() {
            // ----- ÂéüÊúâAPP‰ª£Á†Å ÂÆåÂÖ®‰øùÁïôÔºå‰ªÖÂú®ÊúÄÂ∫ïÈÉ®Ê∑ªÂä†ÂΩ©ËõãÈÄªËæë -----
            function detectDevice() {
                const ua = navigator.userAgent || navigator.vendor || window.opera;
                if (/android/i.test(ua)) return 'android';
                if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'ios';
                return 'ios';
            }
            const deviceType = detectDevice();
            const themeClass = deviceType === 'android' ? 'android-theme' : 'ios-theme';
            const devicePlatform = deviceType;
            const PLATFORM_SPECIFIC_CATEGORIES = ['apps', 'games'];

            function applyTheme() {
                document.getElementById('logoIcon').classList.add(themeClass);
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.classList.contains('active')) item.classList.add(themeClass);
                });
                document.querySelectorAll('.download-badge').forEach(badge => badge.classList.add(themeClass));
            }

            // Â∫îÁî®Êï∞ÊçÆ (‰øùÁïôÂéüÊ†∑)
            let apps = [
                { id: '1-'+Date.now(), name: 'ÊóßÁâàÊäñÈü≥', url: 'https://loadly.io/oldtiktokipa', platform: 'ios', category: 'apps' },
                { id: '2-'+Date.now(), name: 'biliwear', url: 'https://loadly.io/biliwearapk', platform: 'android', category: 'apps' },
                { id: '3-'+Date.now(), name: 'shizuku', url: 'https://loadly.io/shizukumapk', platform: 'android', category: 'apps' },
                { id: '4-'+Date.now(), name: 'pilipala', url: 'https://loadly.io/pilipalaapk', platform: 'android', category: 'apps' },
                { id: '5-'+Date.now(), name: 'pilipala', url: 'https://loadly.io/pilipalaipa', platform: 'ios', category: 'apps' },
                { id: '6-'+Date.now(), name: 'ÊóßÁâàbili', url: 'https://loadly.io/oldbiliipa', platform: 'ios', category: 'apps' },
                { id: '7-'+Date.now(), name: '‰æ†ÁõóÁåéËΩ¶ÊâãÔºöÂú£ÂÆâÂú∞ÂàóÊñØ', url: 'https://loadly.io/gtasaipag', platform: 'ios', category: 'games' },
                { id: '8-'+Date.now(), name: '‰æ†ÁõóÁåéËΩ¶ÊâãÔºöÂú£ÂÆâÂú∞ÂàóÊñØ', url: 'https://loadly.io/gtasaapkg', platform: 'android', category: 'games' }
            ];
            try { const saved = localStorage.getItem('appstore_apps_data'); if (saved) apps = JSON.parse(saved); } catch(e){}
            function saveApps() { try { localStorage.setItem('appstore_apps_data', JSON.stringify(apps)); } catch(e){} }

            // Èü≥‰πêAPI
            const MUSIC_APIS = [
                { name: 'ÁúüÂøÉÊ∫ê', url: 'https://ncm.zhenxin.me', active: true },
                { name: 'Â¢®ÊüìÊ∫ê', url: 'https://zm.i9mr.com', active: true }
            ];

            let currentApiIndex = 0;
            let apiStatus = { checked: false, workingIndex: 0 };

            const API_PATHS = {
                search: '/search?keywords=',
                songUrl: '/song/url?id=',
                lyric: '/lyric?id=',
                detail: '/song/detail?ids='
            };

            async function checkApiAvailability() {
                const testKeyword = 'Âë®Êù∞‰º¶';
                for (let i = 0; i < MUSIC_APIS.length; i++) {
                    const api = MUSIC_APIS[i];
                    try {
                        const testUrl = `${api.url}${API_PATHS.search}${encodeURIComponent(testKeyword)}&limit=1`;
                        const response = await fetch(testUrl, { mode: 'cors', timeout: 5000 });
                        const data = await response.json();
                        if (data.code === 200 && data.result?.songs) {
                            console.log(`‚úÖ APIÂèØÁî®: ${api.name} (${api.url})`);
                            api.active = true;
                            apiStatus.workingIndex = i;
                            apiStatus.checked = true;
                            currentApiIndex = i;
                            return true;
                        }
                    } catch (e) {
                        console.log(`‚ùå API‰∏çÂèØÁî®: ${api.name} (${api.url})`, e);
                        api.active = false;
                    }
                }
                console.warn('‚ö†Ô∏è ÊâÄÊúâAPIÂùá‰∏çÂèØÁî®Ôºå‰ΩøÁî®ÈªòËÆ§');
                apiStatus.checked = true;
                currentApiIndex = 0;
                return false;
            }

            function getCurrentApiUrl() {
                return MUSIC_APIS[currentApiIndex]?.url || MUSIC_APIS[0].url;
            }

            async function trySwitchApi() {
                const startIndex = currentApiIndex;
                for (let i = 0; i < MUSIC_APIS.length; i++) {
                    const nextIndex = (startIndex + i + 1) % MUSIC_APIS.length;
                    const api = MUSIC_APIS[nextIndex];
                    try {
                        const testUrl = `${api.url}${API_PATHS.search}${encodeURIComponent('Âë®Êù∞‰º¶')}&limit=1`;
                        const response = await fetch(testUrl, { mode: 'cors', timeout: 3000 });
                        const data = await response.json();
                        if (data.code === 200 && data.result?.songs) {
                            currentApiIndex = nextIndex;
                            console.log(`üîÑ ÂàáÊç¢Âà∞API: ${api.name}`);
                            return true;
                        }
                    } catch (e) {}
                }
                return false;
            }

            async function requestWithFallback(endpoint, params, maxRetries = 2) {
                for (let attempt = 0; attempt <= maxRetries; attempt++) {
                    const apiUrl = getCurrentApiUrl();
                    const fullUrl = `${apiUrl}${endpoint}${params}`;
                    try {
                        const response = await fetch(fullUrl, { mode: 'cors', timeout: 8000 });
                        const data = await response.json();
                        if (data.code === 200) {
                            return data;
                        } else {
                            throw new Error('APIËøîÂõûÈîôËØØ');
                        }
                    } catch (e) {
                        console.log(`ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÂ∞ùËØïÂàáÊç¢API (${attempt + 1}/${maxRetries})`, e);
                        const switched = await trySwitchApi();
                        if (!switched && attempt === maxRetries) {
                            throw new Error('ÊâÄÊúâAPIÂùá‰∏çÂèØÁî®');
                        }
                    }
                }
                throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•');
            }

            let lastSearchKeyword = '';
            let currentLyricLines = [];
            let lyricUpdateTimer = null;
            let autoScrollEnabled = true;
            let autoScrollTimer = null;
            let lastActiveIndex = -1;

            // DOM ÂÖÉÁ¥†
            const grid = document.getElementById('appsGrid');
            const modal = document.getElementById('appModal');
            const appName = document.getElementById('appName');
            const appUrl = document.getElementById('appUrl');
            const appPlatform = document.getElementById('appPlatform');
            const appCategory = document.getElementById('appCategory');
            const cancelBtn = document.getElementById('cancelModalBtn');
            const saveBtn = document.getElementById('saveAppBtn');
            const fetchInfoBtn = document.getElementById('fetchInfoBtn');
            const platformOptions = document.querySelectorAll('.platform-option');
            const navItems = document.querySelectorAll('.nav-item');
            const floatingPlayer = document.getElementById('floatingPlayer');
            const audioPlayer = document.getElementById('audioPlayer');
            const playerTitle = document.getElementById('playerTitle');
            const playerArtist = document.getElementById('playerArtist');
            const lyricsContainer = document.getElementById('lyricsContainer');
            const closePlayerBtn = document.getElementById('closePlayerBtn');
            const versionToast = document.getElementById('versionToast');
            const searchInput = document.getElementById('searchInput');
            const searchCancelBtn = document.getElementById('searchCancelBtn');

            let currentCategory = 'apps';
            let searchActive = false;

            applyTheme();

            // Âπ≥Âè∞ÈÄâÊã©Âô®
            platformOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                    platformOptions.forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    appPlatform.value = opt.dataset.platform;
                });
            });

            const EXTENSION_RULES = {
                'ipa': { platform: 'ios', category: 'apps' },
                'apk': { platform: 'android', category: 'apps' },
                'ipag': { platform: 'ios', category: 'games' },
                'apkg': { platform: 'android', category: 'games' }
            };
            async function smartFetchFromUrl(url) {
                const match = url.match(/\.([a-zA-Z]+)$/);
                let ext = match ? match[1].toLowerCase() : '';
                let rule = ext && EXTENSION_RULES[ext] ? EXTENSION_RULES[ext] : null;
                let nameFromUrl = '';
                try {
                    const urlObj = new URL(url);
                    const path = urlObj.pathname;
                    let base = path.startsWith('/') ? path.substring(1) : path;
                    if (ext && base.endsWith('.' + ext)) base = base.substring(0, base.length - (ext.length + 1));
                    nameFromUrl = base.replace(/[._-]/g, ' ').trim();
                    if (nameFromUrl === '') nameFromUrl = base;
                } catch (e) {}
                let finalName = nameFromUrl;
                if (!finalName) {
                    try { const host = new URL(url).hostname.replace('www.', ''); finalName = host.split('.')[0]; } catch { finalName = 'Â∫îÁî®'; }
                }
                finalName = finalName.charAt(0).toUpperCase() + finalName.slice(1);
                if (rule) return { name: finalName, platform: rule.platform, category: rule.category, ext: ext };
                else return { name: finalName, platform: 'ios', category: 'apps', ext: ext || 'Êú™Áü•' };
            }
            fetchInfoBtn.addEventListener('click', async () => {
                const url = appUrl.value.trim();
                if (!url) { alert('ËØ∑ËæìÂÖ•‰∏ãËΩΩÈìæÊé•'); return; }
                const status = document.getElementById('fetchStatus');
                status.innerText = 'üîç Ëß£Êûê‰∏≠...';
                fetchInfoBtn.disabled = true;
                try {
                    const info = await smartFetchFromUrl(url);
                    appName.value = info.name;
                    appPlatform.value = info.platform;
                    platformOptions.forEach(o => o.classList.toggle('selected', o.dataset.platform === info.platform));
                    appCategory.value = info.category;
                    status.innerText = `‚úì Â∑≤ËØÜÂà´: ${info.ext}`;
                } catch (error) { status.innerText = '‚ùå Ëß£ÊûêÂ§±Ë¥•'; } 
                finally { fetchInfoBtn.disabled = false; }
            });

            saveBtn.addEventListener('click', () => {
                const name = appName.value.trim();
                const url = appUrl.value.trim();
                const platform = appPlatform.value;
                const category = appCategory.value;
                if (!name || !url) { alert('ËØ∑Â°´ÂÜôÂÆåÊï¥‰ø°ÊÅØ'); return; }
                apps.push({ id: Date.now() + '-' + Math.random(), name, url, platform, category });
                saveApps();
                modal.classList.remove('show');
                renderGrid();
                appName.value = ''; appUrl.value = 'https://loadly.io/'; document.getElementById('fetchStatus').innerText = '';
            });
            cancelBtn.addEventListener('click', () => modal.classList.remove('show'));
            document.querySelector('.logo-icon').addEventListener('click', () => {
                versionToast.classList.add('show');
                setTimeout(() => versionToast.classList.remove('show'), 2000);
            });

            // ========== Ëß£ÊûêLRCÊ≠åËØç ==========
            function parseLRC(lrcText) {
                if (!lrcText) return [];
                const lines = lrcText.split('\n');
                const lyricList = [];
                lines.forEach(line => {
                    const match = line.match(/\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\](.*)/);
                    if (match) {
                        const minutes = parseInt(match[1]);
                        const seconds = parseInt(match[2]);
                        const milliseconds = parseInt(match[3] || '0');
                        const time = minutes * 60 + seconds + milliseconds / 1000;
                        const text = match[4].trim();
                        if (text) lyricList.push({ time, text });
                    }
                });
                lyricList.sort((a, b) => a.time - b.time);
                return lyricList;
            }

            async function fetchLyric(songId) {
                try {
                    const data = await requestWithFallback(API_PATHS.lyric, songId);
                    if (data.lrc && data.lrc.lyric) {
                        return parseLRC(data.lrc.lyric);
                    }
                } catch (e) {
                    console.log('Ëé∑ÂèñÊ≠åËØçÂ§±Ë¥•', e);
                }
                return [];
            }

            function enableAutoScroll() {
                autoScrollEnabled = true;
                if (autoScrollTimer) { clearTimeout(autoScrollTimer); autoScrollTimer = null; }
                forceScrollToCurrentLyric();
            }
            function forceScrollToCurrentLyric() {
                if (!autoScrollEnabled || !currentLyricLines || currentLyricLines.length === 0) return;
                const currentTime = audioPlayer.currentTime;
                let activeIndex = 0;
                let minTimeDiff = Infinity;
                for (let i = 0; i < currentLyricLines.length; i++) {
                    const timeDiff = Math.abs(currentTime - currentLyricLines[i].time);
                    if (timeDiff < minTimeDiff) { minTimeDiff = timeDiff; activeIndex = i; }
                }
                if (activeIndex > 0 && currentTime < currentLyricLines[activeIndex].time) activeIndex--;
                if (activeIndex >= 0) {
                    const lineHeight = 32;
                    const scrollTop = (activeIndex * lineHeight) - (lyricsContainer.clientHeight / 2) + (lineHeight / 2);
                    lyricsContainer.scrollTo({ top: scrollTop, behavior: 'smooth' });
                }
            }
            function onUserScroll() {
                if (autoScrollEnabled) {
                    autoScrollEnabled = false;
                    if (autoScrollTimer) clearTimeout(autoScrollTimer);
                    autoScrollTimer = setTimeout(() => enableAutoScroll(), 5000);
                }
            }
            function onLyricClick(event) {
                const line = event.target;
                const time = parseFloat(line.dataset.time);
                if (!isNaN(time) && audioPlayer) {
                    audioPlayer.currentTime = time;
                    audioPlayer.play().catch(()=>{});
                    enableAutoScroll();
                    updateLyricDisplay(true);
                }
            }
            function updateLyricDisplay(forceHighlight = false) {
                if (!currentLyricLines || currentLyricLines.length === 0) {
                    lyricsContainer.innerHTML = '<div class="no-lyric">ÊöÇÊó†Ê≠åËØç</div>';
                    return;
                }
                const currentTime = audioPlayer.currentTime;
                let activeIndex = 0;
                let minTimeDiff = Infinity;
                for (let i = 0; i < currentLyricLines.length; i++) {
                    const timeDiff = Math.abs(currentTime - currentLyricLines[i].time);
                    if (timeDiff < minTimeDiff) { minTimeDiff = timeDiff; activeIndex = i; }
                }
                if (activeIndex > 0 && currentTime < currentLyricLines[activeIndex].time) activeIndex--;
                if (activeIndex === lastActiveIndex && !forceHighlight) return;
                lastActiveIndex = activeIndex;
                let html = '';
                currentLyricLines.forEach((line, index) => {
                    const activeClass = index === activeIndex ? 'active' : '';
                    html += `<div class="lyric-line ${activeClass} ${themeClass}" data-time="${line.time}">${line.text}</div>`;
                });
                lyricsContainer.innerHTML = html;
                document.querySelectorAll('.lyric-line').forEach(line => line.addEventListener('click', onLyricClick));
                
                if (autoScrollEnabled && activeIndex >= 0) {
                    const lineHeight = 32;
                    const scrollTop = (activeIndex * lineHeight) - lineHeight;
                    lyricsContainer.scrollTo({ top: Math.max(0, scrollTop), behavior: 'smooth' });
                }
            }
            function startLyricTimer() {
                if (lyricUpdateTimer) clearInterval(lyricUpdateTimer);
                lyricUpdateTimer = setInterval(() => updateLyricDisplay(false), 100);
            }
            function stopLyricTimer() {
                if (lyricUpdateTimer) { clearInterval(lyricUpdateTimer); lyricUpdateTimer = null; }
                if (autoScrollTimer) { clearTimeout(autoScrollTimer); autoScrollTimer = null; }
            }
            function setupScrollListener() {
                lyricsContainer.addEventListener('scroll', onUserScroll);
                lyricsContainer.addEventListener('touchstart', onUserScroll);
                lyricsContainer.addEventListener('wheel', onUserScroll);
                lyricsContainer.addEventListener('mousedown', onUserScroll);
            }

            async function searchMusic(keyword, page = 1) {
                if (!keyword) return;
                const container = document.getElementById('music-results-container');
                container.style.display = 'block';
                container.classList.add('has-results');
                container.innerHTML = '<div class="loading">Èü≥‰πêÊêúÁ¥¢‰∏≠(ÂèåÊ∫êÂàáÊç¢)...</div>';
                
                try {
                    const offset = (page - 1) * 10;
                    const data = await requestWithFallback(API_PATHS.search, `${encodeURIComponent(keyword)}&limit=10&offset=${offset}`);
                    
                    if (data.code === 200 && data.result?.songs) {
                        renderMusicResults(data.result.songs, keyword, page, data.result.songCount || 100);
                        fetchSongCovers(data.result.songs);
                    } else {
                        container.innerHTML = '<div class="empty-message">Êú™ÊâæÂà∞Áõ∏ÂÖ≥Ê≠åÊõ≤</div>';
                    }
                } catch (e) {
                    container.innerHTML = '<div class="empty-message">ÊâÄÊúâÈü≥‰πêÊ∫êÂùá‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï</div>';
                }
            }

            function renderMusicResults(songs, keyword, page, total) {
                const container = document.getElementById('music-results-container');
                if (!songs || songs.length === 0) {
                    container.innerHTML = '<div class="empty-message">Êú™ÊâæÂà∞Áõ∏ÂÖ≥Ê≠åÊõ≤</div>';
                    return;
                }
                
                const currentApi = MUSIC_APIS[currentApiIndex];
                let html = `<div class="music-results-list"><div style="text-align:right; margin-bottom:8px;"><span class="api-status">ÂΩìÂâç: ${currentApi.name}</span></div>`;
                
                songs.forEach(song => {
                    const songId = song.id;
                    const songName = song.name;
                    let artists = 'Êú™Áü•Ê≠åÊâã';
                    if (song.artists) artists = song.artists.map(a=>a.name).join('/');
                    else if (song.ar) artists = song.ar.map(a=>a.name).join('/');
                    
                    let album = 'Êú™Áü•‰∏ìËæë';
                    if (song.album) album = song.album.name;
                    else if (song.al) album = song.al.name;
                    
                    html += `<div class="music-item" data-source="netease" data-id="${songId}" data-name="${songName.replace(/"/g, '&quot;')}" data-artist="${artists.replace(/"/g, '&quot;')}">
                        <div class="music-cover" data-song-id="${songId}" id="search-cover-${songId}">üéµ</div>
                        <div class="music-info">
                            <div class="music-title">${songName}<span class="source-tag">${currentApi.name}</span></div>
                            <div class="music-artist">${artists}</div>
                            <div class="music-album">${album}</div>
                        </div>
                    </div>`;
                });
                html += '</div>';
                
                if (total > 10) {
                    html += `<div class="pagination">
                        <button class="page-btn" id="music-prev-page" ${page<=1?'disabled':''}>‚Üê ‰∏ä‰∏ÄÈ°µ</button>
                        <span class="page-info">Á¨¨ ${page} È°µ</span>
                        <button class="page-btn" id="music-next-page" ${songs.length<10?'disabled':''}>‰∏ã‰∏ÄÈ°µ ‚Üí</button>
                    </div>`;
                }
                
                container.innerHTML = html;
                
                const prev = document.getElementById('music-prev-page');
                const next = document.getElementById('music-next-page');
                if (prev) prev.addEventListener('click', ()=> { if(page>1) searchMusic(keyword, page-1); });
                if (next) next.addEventListener('click', ()=> { if(songs.length>=10) searchMusic(keyword, page+1); });
                
                bindMusicItemEvents('#music-results-container .music-item');
            }

            async function fetchSongCovers(songs) {
                for (const song of songs) {
                    const songId = song.id;
                    const coverDiv = document.getElementById(`search-cover-${songId}`);
                    if (!coverDiv) continue;
                    
                    try {
                        const data = await requestWithFallback(API_PATHS.detail, songId);
                        let coverUrl = '';
                        if (data.songs && data.songs[0]) {
                            const songDetail = data.songs[0];
                            if (songDetail.al && songDetail.al.picUrl) coverUrl = songDetail.al.picUrl;
                        }
                        
                        if (coverUrl) {
                            coverDiv.innerHTML = `<img src="${coverUrl}" alt="cover" onerror="this.style.display='none';this.parentNode.innerHTML='üéµ';">`;
                        }
                    } catch (e) {}
                    
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }

            async function loadToplist() {
                const dailyContainer = document.getElementById('daily-recommendations');
                if (!dailyContainer) return;
                dailyContainer.innerHTML = '<div class="loading">Âä†ËΩΩÊéíË°åÊ¶ú‰∏≠...</div>';
                
                const hotKeywords = ['ÁÉ≠Ê≠å', 'ÊµÅË°å', 'ÊäñÈü≥', 'Âë®Êù∞‰º¶', 'Êûó‰øäÊù∞'];
                const randomKeyword = hotKeywords[Math.floor(Math.random() * hotKeywords.length)];
                
                try {
                    const data = await requestWithFallback(API_PATHS.search, `${encodeURIComponent(randomKeyword)}&limit=15`);
                    if (data.code === 200 && data.result?.songs) {
                        renderToplist(data.result.songs);
                        fetchSongCoversForToplist(data.result.songs);
                    } else {
                        dailyContainer.innerHTML = '<div class="empty-message">ÊöÇÊó†Êï∞ÊçÆ</div>';
                    }
                } catch (e) {
                    dailyContainer.innerHTML = '<div class="empty-message">ÊâÄÊúâÈü≥‰πêÊ∫êÂùá‰∏çÂèØÁî®</div>';
                }
            }

            function renderToplist(songs) {
                const dailyContainer = document.getElementById('daily-recommendations');
                let html = '';
                songs.forEach((song, index) => {
                    const songId = song.id;
                    const songName = song.name;
                    let artists = 'Êú™Áü•Ê≠åÊâã';
                    if (song.artists) artists = song.artists.map(a=>a.name).join('/');
                    else if (song.ar) artists = song.ar.map(a=>a.name).join('/');
                    
                    html += `<div class="music-item" data-source="netease" data-id="${songId}" data-name="${songName.replace(/"/g, '&quot;')}" data-artist="${artists.replace(/"/g, '&quot;')}">
                        <div class="music-cover" data-song-id="${songId}" id="daily-cover-${songId}">${index+1}</div>
                        <div class="music-info">
                            <div class="music-title">${songName}<span class="source-tag">ÁÉ≠Ê≠å</span></div>
                            <div class="music-artist">${artists}</div>
                        </div>
                    </div>`;
                });
                dailyContainer.innerHTML = html;
                
                bindMusicItemEvents('#daily-recommendations .music-item');
            }

            async function fetchSongCoversForToplist(songs) {
                for (const song of songs) {
                    const songId = song.id;
                    const coverDiv = document.getElementById(`daily-cover-${songId}`);
                    if (!coverDiv) continue;
                    
                    try {
                        const data = await requestWithFallback(API_PATHS.detail, songId);
                        let coverUrl = '';
                        if (data.songs && data.songs[0]) {
                            const songDetail = data.songs[0];
                            if (songDetail.al && songDetail.al.picUrl) coverUrl = songDetail.al.picUrl;
                        }
                        
                        if (coverUrl) {
                            coverDiv.innerHTML = `<img src="${coverUrl}" alt="cover" onerror="this.style.display='none';this.parentNode.innerHTML='üéµ';">`;
                        }
                    } catch (e) {}
                    
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }

            function refreshToplist() { loadToplist(); }

            async function playMusic(item) {
                const source = item.dataset.source;
                const id = item.dataset.id;
                const name = item.dataset.name;
                const artist = item.dataset.artist;
                
                if (source === 'netease') {
                    floatingPlayer.classList.add('show');
                    playerTitle.innerText = name;
                    playerArtist.innerText = artist;
                    
                    stopLyricTimer();
                    lyricsContainer.innerHTML = '<div class="no-lyric">Âä†ËΩΩÊ≠åËØç‰∏≠...</div>';
                    
                    try {
                        const data = await requestWithFallback(API_PATHS.songUrl, `${id}&br=128000`);
                        let audioUrl = null;
                        if (data.data && data.data[0]?.url) {
                            audioUrl = data.data[0].url;
                        }
                        
                        if (audioUrl) {
                            audioPlayer.src = audioUrl;
                            currentLyricLines = await fetchLyric(id);
                            lastActiveIndex = -1;
                            if (currentLyricLines.length === 0) {
                                lyricsContainer.innerHTML = '<div class="no-lyric">ÊöÇÊó†Ê≠åËØç</div>';
                            } else {
                                autoScrollEnabled = true;
                                updateLyricDisplay(true);
                                startLyricTimer();
                                setupScrollListener();
                            }
                            audioPlayer.play().catch(()=>{});
                        } else {
                            alert('Êó†Ê≥ïËé∑ÂèñÊí≠ÊîæÂú∞ÂùÄÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÊ≠åÊõ≤');
                            lyricsContainer.innerHTML = '<div class="no-lyric">Êí≠ÊîæÂ§±Ë¥•</div>';
                        }
                    } catch (e) {
                        alert('Êí≠ÊîæÂ§±Ë¥•ÔºåÊâÄÊúâAPIÂùá‰∏çÂèØÁî®');
                        lyricsContainer.innerHTML = '<div class="no-lyric">Êí≠ÊîæÂ§±Ë¥•</div>';
                    }
                }
            }

            function bindMusicItemEvents(selector) {
                document.querySelectorAll(selector).forEach(item => {
                    item.addEventListener('click', function() { playMusic(this); });
                });
            }

            function performSearch(keyword, page = 1) {
                if (!keyword.trim()) return;
                searchActive = true;
                lastSearchKeyword = keyword;
                
                if (currentCategory === 'music') {
                    const dailyHeader = document.getElementById('dailyHeader');
                    const dailyRec = document.getElementById('daily-recommendations');
                    if (dailyHeader) dailyHeader.style.display = 'none';
                    if (dailyRec) dailyRec.style.display = 'none';
                    
                    searchMusic(keyword, page);
                } 
                else if (currentCategory === 'books') {
                    const comicIframe = document.getElementById('comicFrame');
                    if (comicIframe) {
                        const SEARCH_URL = 'https://manwa6.com/search?q=';
                        comicIframe.src = SEARCH_URL + encodeURIComponent(keyword);
                    } else { renderGrid(); }
                } 
                else {
                    let filtered = apps.filter(app => app.category === currentCategory);
                    if (PLATFORM_SPECIFIC_CATEGORIES.includes(currentCategory)) {
                        filtered = filtered.filter(app => app.platform === devicePlatform);
                    }
                    const results = filtered.filter(app => app.name.toLowerCase().includes(keyword.toLowerCase()));
                    renderLocalResults(results);
                }
            }

            function renderLocalResults(results) {
                let html = '';
                if (results.length === 0) html = '<div class="empty-message">ÊöÇÊó†ÂåπÈÖçÊñá‰ª∂</div>';
                else {
                    results.forEach(app => {
                        const platformIcon = app.platform === 'ios' ? 'üçé' : 'ü§ñ';
                        const platformTag = app.platform === 'ios' ? 'iOS' : 'Android';
                        html += `<div class="app-card" data-id="${app.id}"><div class="app-icon">${platformIcon}</div><div class="app-info" onclick="window.open('${app.url}', '_blank')"><div class="app-name">${app.name} <span class="app-platform">${platformTag}</span></div><div class="app-url-preview">${app.url}</div><div style="margin-top:6px;"><span class="download-badge ${themeClass}">‰∏ãËΩΩ</span></div></div></div>`;
                    });
                }
                grid.innerHTML = html;
            }

            function resetToHome() {
                searchActive = false;
                searchInput.value = '';
                lastSearchKeyword = '';
                renderGrid();
            }

            function renderGrid() {
                let filtered = apps.filter(app => app.category === currentCategory);
                if (PLATFORM_SPECIFIC_CATEGORIES.includes(currentCategory)) {
                    filtered = filtered.filter(app => app.platform === devicePlatform);
                }
                let html = '';
                
                if (currentCategory === 'music') {
                    html += `<div class="music-section">
                        <div class="daily-header" id="dailyHeader">
                            <div class="daily-title">üéµ ÁÉ≠Èó®Êé®Ëçê</div>
                            <div class="refresh-daily ${themeClass}" id="refreshDailyBtn">‚Üª Êç¢‰∏ÄÊâπ</div>
                        </div>
                        <div id="daily-recommendations" class="loading">Âä†ËΩΩ‰∏≠...</div>
                        <div id="music-results-container" style="display: none;"></div>
                    </div>`;
                    grid.innerHTML = html;
                    
                    checkApiAvailability().then(() => {
                        loadToplist();
                    });
                    
                    document.getElementById('refreshDailyBtn').addEventListener('click', refreshToplist);
                } 
                else if (currentCategory === 'books') {
                    html = `<div class="music-section">
                        <div class="comic-search-tip">üìñ Êº´ÁîªÁ´ô ¬∑ ‰ΩøÁî®‰∏äÊñπÊêúÁ¥¢Ê°ÜÊêúÁ¥¢Êº´Áîª</div>
                        <div class="comic-iframe-container">
                            <iframe id="comicFrame" src="https://manwa6.com/ranking" 
                                    sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"></iframe>
                        </div>
                    </div>`;
                    grid.innerHTML = html;
                } 
                else {
                    if (filtered.length === 0) html = '<div class="empty-message">ÊöÇÊó†Êñá‰ª∂</div>';
                    else {
                        filtered.forEach(app => {
                            const platformIcon = app.platform === 'ios' ? 'üçé' : 'ü§ñ';
                            const platformTag = app.platform === 'ios' ? 'iOS' : 'Android';
                            html += `<div class="app-card" data-id="${app.id}"><div class="app-icon">${platformIcon}</div><div class="app-info" onclick="window.open('${app.url}', '_blank')"><div class="app-name">${app.name} <span class="app-platform">${platformTag}</span></div><div class="app-url-preview">${app.url}</div><div style="margin-top:6px;"><span class="download-badge ${themeClass}">‰∏ãËΩΩ</span></div></div></div>`;
                        });
                    }
                    grid.innerHTML = html;
                }
            }

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const keyword = searchInput.value.trim();
                    if (keyword) { handleSearch(keyword); }
                }
            });
            
            searchCancelBtn.addEventListener('click', resetToHome);

            function handleSearch(keyword) {
                if (!keyword.trim()) { resetToHome(); return; }
                
                if (currentCategory === 'music') {
                    const dailyHeader = document.getElementById('dailyHeader');
                    const dailyRec = document.getElementById('daily-recommendations');
                    if (dailyHeader) dailyHeader.style.display = 'none';
                    if (dailyRec) dailyRec.style.display = 'none';
                    
                    let container = document.getElementById('music-results-container');
                    if (!container) {
                        container = document.createElement('div');
                        container.id = 'music-results-container';
                        document.querySelector('.music-section').appendChild(container);
                    }
                    performSearch(keyword, 1);
                } 
                else if (currentCategory === 'books') {
                    performSearch(keyword, 1);
                }
                else {
                    let filtered = apps.filter(app => app.category === currentCategory);
                    if (PLATFORM_SPECIFIC_CATEGORIES.includes(currentCategory)) {
                        filtered = filtered.filter(app => app.platform === devicePlatform);
                    }
                    const results = filtered.filter(app => app.name.toLowerCase().includes(keyword.toLowerCase()));
                    renderLocalResults(results);
                }
            }

            function setActiveNav(cat) {
                navItems.forEach(item => {
                    item.classList.remove('active', 'ios-theme', 'android-theme');
                    if (item.dataset.cat === cat) item.classList.add('active', themeClass);
                });
            }
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    currentCategory = item.dataset.cat;
                    setActiveNav(currentCategory);
                    renderGrid();
                    searchInput.value = '';
                    searchActive = false;
                    lastSearchKeyword = '';
                });
            });

            closePlayerBtn.addEventListener('click', () => {
                audioPlayer.pause();
                audioPlayer.src = '';
                floatingPlayer.classList.remove('show');
                stopLyricTimer();
                currentLyricLines = [];
                autoScrollEnabled = true;
                lastActiveIndex = -1;
            });

            setActiveNav(currentCategory);
            renderGrid();

            // ---------- ÂΩ©ËõãÊ∏∏ÊàèÊ®°Âùó (ÂµåÂÖ•CÂõæÊ†áÔºå‰∫î‰∏ãËß¶ÂèëÔºåÂÖ≥Èó≠ÈáçÁΩÆ) ----------
            const logo = document.getElementById('logoIcon');
            const gameOverlay = document.getElementById('gameOverlay');
            const closeGameBtn = document.getElementById('closeGameBtn');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            let clickCount = 0;
            let gameInitialized = false;
            let gameLoopId = null;
            let gamePaused = false;

            // Ê∏∏ÊàèÁä∂ÊÄÅÂèòÈáè (ÊØèÊ¨°ÈáçÁΩÆ‰ºöÈáçÊñ∞ÂàùÂßãÂåñ)
            let dino, obstacles, apple, health, gameOver, frame, score, speed, spawnRate;
            const GROUND_Y = 250;
            const DINO_WIDTH = 30, DINO_HEIGHT = 40, DINO_X = 70;
            const MAX_HEALTH = 3, BASE_SPEED = 4.5, MAX_SPEED = 12, MIN_SPAWN_RATE = 45;
            const APPLE_SPAWN_CHANCE = 0.006;

            function resetGameState() {
                dino = {
                    x: DINO_X, y: GROUND_Y - DINO_HEIGHT,
                    width: DINO_WIDTH, height: DINO_HEIGHT,
                    vy: 0, gravity: 0.55, jumpPower: -12, grounded: true
                };
                obstacles = [];
                apple = null;
                health = MAX_HEALTH;
                gameOver = false;
                frame = 0;
                score = 0;
                speed = BASE_SPEED;
                spawnRate = 80;
            }

            function rectCollide(x1,y1,w1,h1,x2,y2,w2,h2) {
                return x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2;
            }

            function spawnObstacle() {
                let width = 8 + Math.floor(Math.random() * 14);
                let height = 20 + Math.floor(Math.random() * 15);
                obstacles.push({
                    x: canvas.width, y: GROUND_Y - height,
                    width, height, passed: false
                });
            }

            function trySpawnApple() {
                if (apple !== null) return false;
                if (Math.random() < APPLE_SPAWN_CHANCE) {
                    const size = 18 + Math.floor(Math.random() * 6);
                    apple = { x: canvas.width, y: GROUND_Y - size - 2, width: size, height: size, collected: false };
                    return true;
                }
                return false;
            }

            function performJump() {
                if (gameOver) {
                    resetGameState();
                    return;
                }
                if (dino.grounded) {
                    dino.vy = dino.jumpPower;
                    dino.grounded = false;
                }
            }

            function updateGame() {
                if (gameOver || gamePaused) return;

                dino.vy += dino.gravity;
                dino.y += dino.vy;
                if (dino.y >= GROUND_Y - DINO_HEIGHT) {
                    dino.y = GROUND_Y - DINO_HEIGHT;
                    dino.vy = 0; dino.grounded = true;
                } else dino.grounded = false;

                for (let i=obstacles.length-1; i>=0; i--) {
                    let obs = obstacles[i];
                    obs.x -= speed;
                    if (!obs.passed && obs.x + obs.width < dino.x) { obs.passed = true; score += 10; }
                    if (obs.x + obs.width < 0) obstacles.splice(i,1);
                }

                if (apple && !apple.collected) {
                    apple.x -= speed;
                    if (rectCollide(dino.x, dino.y, dino.width, dino.height, apple.x, apple.y, apple.width, apple.height)) {
                        apple.collected = true;
                        if (health < MAX_HEALTH) health++;
                    }
                    if (apple.x + apple.width < 0 || apple.collected) apple = null;
                }

                for (let i=obstacles.length-1; i>=0; i--) {
                    let obs = obstacles[i];
                    if (rectCollide(dino.x, dino.y, dino.width, dino.height, obs.x, obs.y, obs.width, obs.height)) {
                        health--;
                        obstacles.splice(i,1);
                        if (health <= 0) { gameOver = true; health = 0; break; }
                    }
                }

                if (gameOver) return;

                if (speed < MAX_SPEED) speed = BASE_SPEED + Math.floor(score/200);
                if (speed > MAX_SPEED) speed = MAX_SPEED;
                spawnRate = Math.max(MIN_SPAWN_RATE, 80 - Math.floor(score/20));

                if (frame % spawnRate === 0 || (Math.random()<0.3 && frame%30===0)) {
                    let lastObsX = canvas.width+1;
                    for (let obs of obstacles) if (obs.x > canvas.width*0.5) lastObsX = Math.min(lastObsX, obs.x);
                    if (lastObsX > canvas.width-120 || obstacles.length===0) spawnObstacle();
                }

                trySpawnApple();
                frame++;
            }

            function drawGame() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#333';
                ctx.fillRect(0, GROUND_Y, canvas.width, 3);
                ctx.fillStyle = '#555';
                for (let i=0; i<8; i++) {
                    let x = (frame * 2.5 + i * 45) % canvas.width;
                    ctx.fillRect(x, GROUND_Y+5, 15, 2);
                }

                // ÊÅêÈæô
                ctx.fillStyle = '#2c3e50';
                ctx.fillRect(dino.x, dino.y, dino.width, dino.height);
                ctx.fillStyle = 'white';
                ctx.fillRect(dino.x+20, dino.y+6, 6, 6);
                ctx.fillStyle = '#111';
                ctx.fillRect(dino.x+24, dino.y+8, 3, 3);
                ctx.fillStyle = '#f1c40f';
                ctx.fillRect(dino.x+5, dino.y+20, 3, 5);
                ctx.fillRect(dino.x+12, dino.y+20, 3, 5);
                ctx.fillStyle = '#1e2b38';
                ctx.fillRect(dino.x, dino.y+dino.height, 8, 5);
                ctx.fillRect(dino.x+18, dino.y+dino.height, 8, 5);
                ctx.fillStyle = '#e67e22';
                ctx.fillRect(dino.x+5, dino.y-4, 7, 6);
                ctx.fillRect(dino.x+12, dino.y-6, 7, 8);

                // ÈöúÁ¢çÁâ©
                for (let obs of obstacles) {
                    const greenShades = ['#2ecc71', '#27ae60', '#229954'];
                    const shade = greenShades[Math.floor(Math.random() * greenShades.length)];
                    ctx.fillStyle = shade;
                    ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                    ctx.fillStyle = '#f1c40f';
                    ctx.fillRect(obs.x-2, obs.y+5, 3, 3);
                    ctx.fillRect(obs.x+obs.width-1, obs.y+12, 3, 3);
                    ctx.fillStyle = '#1e8449';
                    ctx.fillRect(obs.x+4, obs.y+8, 3, 5);
                }

                // ËãπÊûú
                if (apple && !apple.collected) {
                    ctx.fillStyle = '#e74c3c';
                    ctx.fillRect(apple.x, apple.y, apple.width, apple.height);
                    ctx.fillStyle = '#2ecc71';
                    ctx.fillRect(apple.x + apple.width/2 -2, apple.y-4, 5, 5);
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(apple.x+4, apple.y+4, 3, 3);
                }

                if (gameOver) {
                    ctx.fillStyle = 'rgba(0,0,0,0.7)';
                    ctx.fillRect(0,0,canvas.width, canvas.height);
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 34px "Courier New", monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText('GAME OVER', canvas.width/2, canvas.height/2-20);
                    ctx.font = '20px "Courier New"';
                    ctx.fillText('ÁÇπÂáªÁîªÈù¢ÈáçÂºÄ', canvas.width/2, canvas.height/2+30);
                }

                ctx.font = 'bold 22px "Courier New"';
                ctx.fillStyle = '#2c3e50';
                ctx.fillText(`‚§¥ ${Math.floor(score)}`, 660, 60);
                for (let i=0; i<health; i++) {
                    ctx.fillStyle = '#e74c3c';
                    ctx.font = '26px "Courier New"';
                    ctx.fillText('‚ù§Ô∏è', 30 + i*36, 60);
                }
            }

            function gameLoop() {
                if (!gamePaused) updateGame();
                drawGame();
                gameLoopId = requestAnimationFrame(gameLoop);
            }

            function initGame() {
                resetGameState();
                gamePaused = false;
                if (!gameLoopId) gameLoop();
            }

            // ÁÇπÂáªlogoÁ¥ØËÆ°‰∫îÊ¨°ÊâìÂºÄÊ∏∏ÊàèÔºåÂπ∂ÈáçÁΩÆÁä∂ÊÄÅ
            logo.addEventListener('click', (e) => {
                clickCount++;
                if (clickCount >= 5) {
                    clickCount = 0;
                    gameOverlay.classList.add('show');
                    if (!gameInitialized) {
                        initGame();
                        gameInitialized = true;
                    } else {
                        // ÊØèÊ¨°ÊâìÂºÄÂº∫Âà∂ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆ (ÂÖ≥Èó≠ÂêéÂÜçÂºÄÂàÜÊï∞Ê∏ÖÈõ∂)
                        resetGameState();
                    }
                }
            });

            // ÂÖ≥Èó≠Ê∏∏ÊàèÊµÆÂ±Ç (ÂêåÊó∂ÈáçÁΩÆÊï∞ÊçÆ)
            closeGameBtn.addEventListener('click', () => {
                gameOverlay.classList.remove('show');
                resetGameState();          // ÂÖ≥Èó≠Êó∂ÂΩªÂ∫ïÈáçÁΩÆÂàÜÊï∞/Ë°ÄÈáè
                // ‰∏çÊ∏ÖÈô§ÁîªÂ∏ÉÔºå‰∏ãÊ¨°ÊâìÂºÄÈáçÊñ∞ÁªòÂà∂
            });

            // ÁÇπÂáªcanvas‰ªªÊÑè‰ΩçÁΩÆËß¶ÂèëË∑≥Ë∑É (ÂÖ®Â±èËß¶Êë∏)
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                performJump();
            }, { passive: false });
            canvas.addEventListener('mousedown', (e) => {
                e.preventDefault();
                performJump();
            });

            // Á°Æ‰øùÊ∏∏ÊàèÊöÇÂÅú/ÊÅ¢Â§ç
            gameOverlay.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        })();
    </script>
</body>
</html>