<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>APP Store Â· éŸ³ä¹æ¯æ—¥æ¨è</title>
    <style>
        /* ===== åŸºç¡€æ ·å¼ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            background: #0a0a0c;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 16px 12px 0px;
            color: #ffffff;
        }

        .container {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding-bottom: 100px;
        }

        /* å¤´éƒ¨ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 8px;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s;
            cursor: pointer;
        }

        .logo-icon.ios-theme {
            background: #1e88e5;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.4);
        }

        .logo-icon.android-theme {
            background: #4CAF50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .logo-text {
            font-size: 22px;
            font-weight: 600;
            color: #fff;
        }

        .logo-text small {
            font-size: 13px;
            color: #888;
            font-weight: 400;
            margin-left: 4px;
        }

        /* ===== åˆ†åŒºæœç´¢æ¡ (å¸¦å–æ¶ˆæŒ‰é’®) ===== */
        .search-bar {
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            border-radius: 30px;
            padding: 6px 6px 6px 18px;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 4px;
        }

        .search-bar span {
            font-size: 18px;
            color: #888;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            flex: 1;
            outline: none;
            padding: 8px 0;
        }

        .search-bar input::placeholder {
            color: #555;
        }

        .search-cancel {
            background: #2c2c2e;
            border: none;
            color: #aaa;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            border: 0.5px solid #3a3a3c;
        }

        .search-cancel:active {
            background: #3a3a3c;
            color: white;
        }

        /* åº”ç”¨å¡ç‰‡ç½‘æ ¼ */
        .apps-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            margin-top: 4px;
            padding-bottom: 20px;
        }

        .app-card {
            background: #1c1c1e;
            border-radius: 24px;
            padding: 16px;
            border: 1px solid #2c2c2e;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            transition: all 0.2s;
        }

        .app-card:active {
            background: #2c2c2e;
            transform: scale(0.99);
        }

        .app-icon {
            width: 70px;
            height: 70px;
            border-radius: 20px;
            background: #2c2c2e;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 38px;
            border: 2px solid #3a3a3c;
            color: #aaa;
        }

        .app-info {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .app-name {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-platform {
            font-size: 12px;
            background: #2c2c2e;
            padding: 3px 10px;
            border-radius: 20px;
            color: #aaa;
            display: inline-block;
            border: 0.5px solid #3a3a3c;
        }

        .app-url-preview {
            font-size: 12px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
            margin-bottom: 8px;
        }

        .download-badge {
            color: white;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 30px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            background: #1e88e5;
            box-shadow: 0 2px 8px rgba(30, 136, 229, 0.3);
        }
        .download-badge.ios-theme {
            background: #1e88e5;
        }
        .download-badge.android-theme {
            background: #4CAF50;
        }
        /* å»æ‰å‘ä¸‹çš„ç®­å¤´ */
        .download-badge::after {
            display: none;
        }

        /* éŸ³ä¹åˆ†åŒºä¸“å±æ ·å¼ */
        .music-section {
            width: 100%;
        }

        /* æ¯æ—¥æ¨èå¤´éƒ¨ + æ¢ä¸€æ‰¹æŒ‰é’® */
        .daily-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0 12px;
        }
        .daily-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
        }
        /* å»æ‰â€œä»Šæ—¥çƒ­æ­Œâ€å°æ ‡ç­¾ */
        .daily-title span {
            display: none;
        }
        .refresh-daily {
            background: #2c2c2e;
            border: 1px solid #3a3a3c;
            color: #aaa;
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .refresh-daily:active {
            background: #3a3a3c;
            color: white;
        }
        .refresh-daily.ios-theme:active {
            background: #1e88e5;
            color: white;
            border-color: #1e88e5;
        }
        .refresh-daily.android-theme:active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* éŸ³ä¹å¡ç‰‡ (æœç´¢ç»“æœå’Œæ¯æ—¥æ¨èå…±ç”¨) - å»æ‰äº†æ’­æ”¾å›¾æ ‡ */
        .music-item {
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .music-item:active {
            background: #2c2c2e;
            transform: scale(0.99);
        }

        .music-cover {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: #2c2c2e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #888;
            overflow: hidden;
            flex-shrink: 0;
        }

        .music-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .music-info {
            flex: 1;
            min-width: 0;
        }

        .music-title {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-artist {
            font-size: 13px;
            color: #aaa;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .music-album {
            font-size: 11px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ä¸å†æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡ */
        .play-icon-small {
            display: none;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 30px;
            color: #888;
            background: #1c1c1e;
            border-radius: 16px;
            border: 1px solid #2c2c2e;
            margin-top: 20px;
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60%, 100% { content: "..."; }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #555;
            background: #1c1c1e;
            border-radius: 16px;
            border: 2px dashed #2c2c2e;
            margin-top: 20px;
            font-size: 15px;
        }

        .empty-message .big-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* åˆ†é¡µå¯¼èˆª (éŸ³ä¹æœç´¢ç»“æœç”¨) */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 10px;
            background: #1c1c1e;
            border: 1px solid #2c2c2e;
            border-radius: 40px;
        }

        .page-btn {
            background: transparent;
            border: none;
            color: #888;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn.active {
            background: #1e88e5;
            color: white;
        }

        .page-btn:active {
            background: #2c2c2e;
        }

        .page-info {
            color: #888;
            font-size: 14px;
        }

        /* æ‚¬æµ®æ’­æ”¾å™¨ */
        .floating-player {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 400px;
            background: rgba(28, 28, 30, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 16px;
            z-index: 150;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            display: none;
        }

        .floating-player.show {
            display: block;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .now-playing-info {
            flex: 1;
        }

        .now-playing-title {
            font-size: 15px;
            font-weight: 600;
            color: white;
        }

        .now-playing-artist {
            font-size: 12px;
            color: #888;
        }

        .close-player {
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
            padding: 0 10px;
        }

        .close-player:active {
            color: white;
        }

        .audio-wrapper audio {
            width: 100%;
            height: 44px;
            border-radius: 22px;
            background: #2c2c2e;
        }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 360px;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 6px 4px;
            z-index: 100;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.8);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #8e8e93;
            font-size: 11px;
            font-weight: 500;
            padding: 6px 0;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            width: 60px;
            gap: 2px;
        }

        .nav-item.active {
            color: white;
        }

        .nav-item.active.ios-theme {
            background: rgba(30, 136, 229, 0.2);
        }

        .nav-item.active.android-theme {
            background: rgba(76, 175, 80, 0.2);
        }

        .nav-item i {
            font-size: 20px;
            font-style: normal;
        }

        /* å¼¹çª—ç›¸å…³ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            padding: 16px;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* ç‰ˆæœ¬æç¤º */
        .version-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 14px 28px;
            border-radius: 40px;
            font-size: 16px;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border: 1px solid #555;
        }
        .version-toast.show {
            opacity: 1;
        }

        /* éšè—åŸå…ˆçš„å…¨å±€æœç´¢æ¡ */
        .global-search-bar {
            display: none;
        }

        /* æœç´¢ç»“æœåŒºåŸŸé»˜è®¤éšè—ï¼Œåªåœ¨æœç´¢åæ˜¾ç¤º */
        #music-results-container {
            display: none;
        }
        /* å½“æœ‰æœç´¢ç»“æœæ—¶æ˜¾ç¤º */
        #music-results-container.has-results {
            display: block;
        }
        /* æœç´¢ç»“æœæ ‡é¢˜é»˜è®¤éšè— */
        .results-title {
            display: none;
            margin-top: 20px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }
        .results-title.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="version-toast" id="versionToast">ğŸµ éŸ³ä¹åˆ†åŒº Â· æ¯æ—¥æ¨è</div>

    <div class="container">
        <!-- å¤´éƒ¨ - æ”¹ä¸º APP store -->
        <div class="header">
            <div class="logo-area">
                <div class="logo-icon" id="logoIcon">C</div>
                <div class="logo-text">APP store</div>
            </div>
        </div>

        <!-- åˆ†åŒºæœç´¢æ¡ (å¸¦å–æ¶ˆæŒ‰é’®) -->
        <div class="search-bar" id="searchBar">
            <span>ğŸ”</span>
            <input type="text" id="searchInput" placeholder="æœç´¢å½“å‰åˆ†åŒº..." autocomplete="off">
            <button class="search-cancel" id="searchCancelBtn">å–æ¶ˆ</button>
        </div>

        <!-- åº”ç”¨å¡ç‰‡ç½‘æ ¼ -->
        <div class="apps-grid" id="appsGrid"></div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="bottom-nav" id="bottomNav">
        <button class="nav-item active" data-cat="apps"><i>ğŸ“±</i> åº”ç”¨</button>
        <button class="nav-item" data-cat="games"><i>ğŸ®</i> æ¸¸æˆ</button>
        <button class="nav-item" data-cat="movies"><i>ğŸ¬</i> ç”µå½±</button>
        <button class="nav-item" data-cat="music"><i>ğŸµ</i> éŸ³ä¹</button>
        <button class="nav-item" data-cat="books"><i>ğŸ“š</i> å›¾ä¹¦</button>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— -->
    <div class="modal" id="appModal">
        <div class="modal-card">
            <h2 id="modalTitle">æ·»åŠ åº”ç”¨åˆ°æ”¶è—</h2>
            <div class="input-field">
                <label>åº”ç”¨åç§°</label>
                <input type="text" id="appName" placeholder="ä¾‹å¦‚: æˆ‘çš„åº”ç”¨">
            </div>
            <div class="input-field">
                <label>ä¸‹è½½é“¾æ¥</label>
                <div class="url-input-row">
                    <input type="url" id="appUrl" placeholder="https://loadly.io/..." value="https://loadly.io/">
                    <button class="fetch-btn" id="fetchInfoBtn">è·å–</button>
                </div>
                <div id="fetchStatus" class="fetch-status"></div>
            </div>
            <div class="input-field">
                <label>å¹³å°</label>
                <div class="platform-selector" id="platformSelector">
                    <div class="platform-option selected" data-platform="ios"><i>ğŸ</i> iOS</div>
                    <div class="platform-option" data-platform="android"><i>ğŸ¤–</i> Android</div>
                </div>
                <input type="hidden" id="appPlatform" value="ios">
            </div>
            <div class="input-field">
                <label>åˆ†ç±»</label>
                <select id="appCategory">
                    <option value="apps">ğŸ“± åº”ç”¨</option>
                    <option value="games">ğŸ® æ¸¸æˆ</option>
                    <option value="movies">ğŸ¬ ç”µå½±</option>
                    <option value="music">ğŸµ éŸ³ä¹</option>
                    <option value="books">ğŸ“š å›¾ä¹¦</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelModalBtn">å–æ¶ˆ</button>
                <button class="modal-btn primary" id="saveAppBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ‚¬æµ®æ’­æ”¾å™¨ -->
    <div class="floating-player" id="floatingPlayer">
        <div class="player-header">
            <div class="now-playing-info">
                <div class="now-playing-title" id="playerTitle">è¯·é€‰æ‹©æ­Œæ›²</div>
                <div class="now-playing-artist" id="playerArtist"></div>
            </div>
            <button class="close-player" id="closePlayerBtn">âœ•</button>
        </div>
        <div class="audio-wrapper">
            <audio id="audioPlayer" controls controlslist="nodownload"></audio>
        </div>
    </div>

    <script>
        (function() {
            // ========== è®¾å¤‡æ£€æµ‹ ==========
            function detectDevice() {
                const ua = navigator.userAgent || navigator.vendor || window.opera;
                if (/android/i.test(ua)) return 'android';
                if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'ios';
                return 'ios';
            }
            const deviceType = detectDevice();
            const themeClass = deviceType === 'android' ? 'android-theme' : 'ios-theme';
            const devicePlatform = deviceType;

            const PLATFORM_SPECIFIC_CATEGORIES = ['apps', 'games'];

            function applyTheme() {
                document.getElementById('logoIcon').classList.add(themeClass);
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.classList.contains('active')) item.classList.add(themeClass);
                });
                // ç»™ä¸‹è½½å¾½ç« ä¹ŸåŠ ä¸Šä¸»é¢˜
                document.querySelectorAll('.download-badge').forEach(badge => {
                    badge.classList.add(themeClass);
                });
            }

            // ========== æ ¸å¿ƒæ•°æ® ==========
            let apps = [
                { id: '1-' + Date.now(), name: 'æ—§ç‰ˆæŠ–éŸ³', url: 'https://loadly.io/oldtiktokipa', platform: 'ios', category: 'apps' },
                { id: '2-' + Date.now(), name: 'biliwear', url: 'https://loadly.io/biliwearapk', platform: 'android', category: 'apps' },
                { id: '3-' + Date.now(), name: 'shizuku', url: 'https://loadly.io/shizukumapk', platform: 'android', category: 'apps' },
                { id: '4-' + Date.now(), name: 'pilipala', url: 'https://loadly.io/pilipalaapk', platform: 'android', category: 'apps' },
                { id: '5-' + Date.now(), name: 'pilipala', url: 'https://loadly.io/pilipalaipa', platform: 'ios', category: 'apps' },
                { id: '6-' + Date.now(), name: 'æ—§ç‰ˆbili', url: 'https://loadly.io/oldbiliipa', platform: 'ios', category: 'apps' },
                { id: '7-' + Date.now(), name: 'ä¾ ç›—çŒè½¦æ‰‹ï¼šåœ£å®‰åœ°åˆ—æ–¯', url: 'https://loadly.io/gtasaipag', platform: 'ios', category: 'games' },
                { id: '8-' + Date.now(), name: 'ä¾ ç›—çŒè½¦æ‰‹ï¼šåœ£å®‰åœ°åˆ—æ–¯', url: 'https://loadly.io/gtasaapkg', platform: 'android', category: 'games' }
            ];

            try {
                const saved = localStorage.getItem('appstore_apps_data');
                if (saved) apps = JSON.parse(saved);
            } catch (e) {}

            function saveApps() {
                try { localStorage.setItem('appstore_apps_data', JSON.stringify(apps)); } catch (e) {}
            }

            // ========== éŸ³ä¹API ==========
            const MUSIC_API = {
                search: 'http://kuwo.bfmzdx.cn/kuwo/search/searchMusicBykeyWord',
                url: 'http://kuwo.bfmzdx.cn/kuwo/url',
                pic: 'http://kuwo.bfmzdx.cn/kuwo/pic'
            };

            const recommendArtists = [
                'å‘¨æ°ä¼¦', 'æ—ä¿Šæ°', 'é‚“ç´«æ£‹', 'é™ˆå¥•è¿…', 'Beyond', 'åˆ˜å¾·å', 'å¼ å­¦å‹', 'ç‹è²', 'é‚£è‹±', 'å­™ç‡•å§¿',
                'è”¡ä¾æ—', 'å¼ æƒ å¦¹', 'ä¼ä½°', 'äº”æœˆå¤©', 'è‹æ‰“ç»¿', 'æ¨åƒå¬…', 'å®¹ç¥–å„¿', 'è°¢éœ†é”‹', 'ç‹åŠ›å®', 'é™¶å–†',
                'æå®—ç››', 'ç½—å¤§ä½‘', 'å¼ å®‡', 'é»„å“æº', 'ä»»è´¤é½', 'å¼ ä¿¡å“²', 'å…‰è‰¯', 'å“å† ', 'æ— å°è‰¯å“', 'æ¢é™èŒ¹',
                'æˆ´ä½©å¦®', 'èŒƒç®çª', 'éƒ­é™', 'å¼ éŸ¶æ¶µ', 'ç‹å¿ƒå‡Œ', 'æ¨ä¸ç³', 'è”¡å¥é›…', 'å¾ä½³è¹', 'Hebe', 'ç”°é¦¥ç”„',
                'é™ˆç»®è´', 'å¼ æ‚¬', 'é­å¦‚è±', 'è‰ä¸œæ²¡æœ‰æ´¾å¯¹', 'è½æ—¥é£è½¦', 'å‘Šäº”äºº', 'æ¤…å­ä¹å›¢', 'åº·å§†å£«', 'æ—…è¡Œå›¢', 'åˆºçŒ¬',
                'æ–°è£¤å­', 'ç—›ä»°', 'é‡å¡‘é›•åƒçš„æƒåˆ©', 'ä¸‡èƒ½é’å¹´æ—…åº—', 'æµ·é¾Ÿå…ˆç”Ÿ', 'äº”æ¡äºº', 'é©¬é ”', 'å®‹å†¬é‡', 'èµµé›·', 'é™ˆç²’',
                'æˆ¿ä¸œçš„çŒ«', 'å¥½å¦¹å¦¹', 'ç¨‹ç’§', 'èŠ±ç²¥', 'éš”å£è€æ¨Š', 'GAI', 'VAVA', 'è‰¾çƒ­', 'æ¨å’Œè‹', 'åˆ˜èª',
                'ç››å®‡', 'Jony J', 'æ³•è€', 'æ—©å®‰', 'ICE', 'ç‹ä»¥å¤ª', 'è‰¾ç¦æ°å°¼', 'é»„æ—­', 'æ´¾å…‹ç‰¹', 'CREAM D',
                'æå¥', 'å‘¨æ·±', 'æ¯›ä¸æ˜“', 'å•ä¾çº¯', 'é»„éœ„äº‘'
            ];

            function toHttp(url) {
                if (!url) return "";
                return url.replace("https://", "http://");
            }

            function getCoverUrl(rid) {
                return `${MUSIC_API.pic}?mid=${rid}`;
            }

            // DOMå…ƒç´ 
            const grid = document.getElementById('appsGrid');
            const modal = document.getElementById('appModal');
            const appName = document.getElementById('appName');
            const appUrl = document.getElementById('appUrl');
            const appPlatform = document.getElementById('appPlatform');
            const appCategory = document.getElementById('appCategory');
            const cancelBtn = document.getElementById('cancelModalBtn');
            const saveBtn = document.getElementById('saveAppBtn');
            const fetchInfoBtn = document.getElementById('fetchInfoBtn');
            const platformOptions = document.querySelectorAll('.platform-option');
            const navItems = document.querySelectorAll('.nav-item');
            const floatingPlayer = document.getElementById('floatingPlayer');
            const audioPlayer = document.getElementById('audioPlayer');
            const playerTitle = document.getElementById('playerTitle');
            const playerArtist = document.getElementById('playerArtist');
            const closePlayerBtn = document.getElementById('closePlayerBtn');
            const versionToast = document.getElementById('versionToast');
            const searchInput = document.getElementById('searchInput');
            const searchCancelBtn = document.getElementById('searchCancelBtn');

            let currentCategory = 'apps';
            let searchActive = false;

            applyTheme();

            // å¹³å°é€‰æ‹©å™¨
            platformOptions.forEach(opt => {
                opt.addEventListener('click', () => {
                    platformOptions.forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    appPlatform.value = opt.dataset.platform;
                });
            });

            // æ™ºèƒ½è·å–ä¿¡æ¯
            const EXTENSION_RULES = {
                'ipa': { platform: 'ios', category: 'apps' },
                'apk': { platform: 'android', category: 'apps' },
                'ipag': { platform: 'ios', category: 'games' },
                'apkg': { platform: 'android', category: 'games' }
            };

            async function smartFetchFromUrl(url) {
                const match = url.match(/\.([a-zA-Z]+)$/);
                let ext = match ? match[1].toLowerCase() : '';
                let rule = ext && EXTENSION_RULES[ext] ? EXTENSION_RULES[ext] : null;
                let nameFromUrl = '';
                try {
                    const urlObj = new URL(url);
                    const path = urlObj.pathname;
                    let base = path.startsWith('/') ? path.substring(1) : path;
                    if (ext && base.endsWith('.' + ext)) {
                        base = base.substring(0, base.length - (ext.length + 1));
                    }
                    nameFromUrl = base.replace(/[._-]/g, ' ').trim();
                    if (nameFromUrl === '') nameFromUrl = base;
                } catch (e) {}
                let finalName = nameFromUrl;
                if (!finalName) {
                    try {
                        const host = new URL(url).hostname.replace('www.', '');
                        finalName = host.split('.')[0];
                    } catch {
                        finalName = 'åº”ç”¨';
                    }
                }
                finalName = finalName.charAt(0).toUpperCase() + finalName.slice(1);
                if (rule) {
                    return { name: finalName, platform: rule.platform, category: rule.category, ext: ext };
                } else {
                    return { name: finalName, platform: 'ios', category: 'apps', ext: ext || 'æœªçŸ¥' };
                }
            }

            fetchInfoBtn.addEventListener('click', async () => {
                const url = appUrl.value.trim();
                if (!url) { alert('è¯·è¾“å…¥ä¸‹è½½é“¾æ¥'); return; }
                const status = document.getElementById('fetchStatus');
                status.innerText = 'ğŸ” è§£æä¸­...';
                fetchInfoBtn.disabled = true;
                try {
                    const info = await smartFetchFromUrl(url);
                    appName.value = info.name;
                    appPlatform.value = info.platform;
                    platformOptions.forEach(o => {
                        o.classList.toggle('selected', o.dataset.platform === info.platform);
                    });
                    appCategory.value = info.category;
                    status.innerText = `âœ“ å·²è¯†åˆ«: ${info.ext}`;
                } catch (error) {
                    status.innerText = 'âŒ è§£æå¤±è´¥';
                } finally {
                    fetchInfoBtn.disabled = false;
                }
            });

            saveBtn.addEventListener('click', () => {
                const name = appName.value.trim();
                const url = appUrl.value.trim();
                const platform = appPlatform.value;
                const category = appCategory.value;
                if (!name || !url) { alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯'); return; }
                const newApp = { id: Date.now() + '-' + Math.random(), name: name, url: url, platform: platform, category: category };
                apps.push(newApp);
                saveApps();
                modal.classList.remove('show');
                renderGrid();
                appName.value = '';
                appUrl.value = 'https://loadly.io/';
                document.getElementById('fetchStatus').innerText = '';
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });

            document.querySelector('.logo-icon').addEventListener('click', () => {
                versionToast.classList.add('show');
                setTimeout(() => versionToast.classList.remove('show'), 2000);
            });

            // ========== éŸ³ä¹æœç´¢å‡½æ•° ==========
            function searchMusic(keyword, page = 1) {
                if (!keyword) return;
                const musicContainer = document.getElementById('music-results-container');
                if (!musicContainer) return;
                
                // æ˜¾ç¤ºæœç´¢ç»“æœå®¹å™¨
                musicContainer.style.display = 'block';
                musicContainer.classList.add('has-results');
                musicContainer.innerHTML = '<div class="loading">æœç´¢éŸ³ä¹ä¸­...</div>';
                
                const url = `${MUSIC_API.search}?key=${encodeURIComponent(keyword)}&pn=${page}&rn=10`;
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.data && data.data.list) {
                            renderMusicResults(data.data.list, keyword, page, data.data.total);
                        } else {
                            musicContainer.innerHTML = '<div class="empty-message">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                        }
                    })
                    .catch(err => {
                        console.error('æœç´¢å¤±è´¥', err);
                        musicContainer.innerHTML = '<div class="empty-message">ç½‘ç»œè¯·æ±‚å¤±è´¥</div>';
                    });
            }

            function renderMusicResults(list, keyword, page, total) {
                const musicContainer = document.getElementById('music-results-container');
                if (!musicContainer) return;
                if (!list || list.length === 0) {
                    musicContainer.innerHTML = '<div class="empty-message">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                    return;
                }
                let html = '<div class="music-results-list">';
                list.forEach(item => {
                    const rid = item.rid;
                    const coverUrl = getCoverUrl(rid);
                    html += `
                        <div class="music-item" data-rid="${rid}" data-name="${item.name.replace(/"/g, '&quot;')}" data-artist="${item.artist.replace(/"/g, '&quot;')}">
                            <div class="music-cover"><img src="${coverUrl}" alt="cover" onerror="this.style.display='none';this.parentNode.innerHTML='ğŸµ';"></div>
                            <div class="music-info">
                                <div class="music-title">${item.name}</div>
                                <div class="music-artist">${item.artist}</div>
                                <div class="music-album">${item.album || 'æœªçŸ¥ä¸“è¾‘'}</div>
                            </div>
                            <!-- æ’­æ”¾å›¾æ ‡å·²ç§»é™¤ -->
                        </div>
                    `;
                });
                html += '</div>';
                if (total > 10) {
                    html += `<div class="pagination"><button class="page-btn" id="music-prev-page" ${page <= 1 ? 'disabled' : ''}>â† ä¸Šä¸€é¡µ</button><span class="page-info">ç¬¬ ${page} é¡µ</span><button class="page-btn" id="music-next-page" ${list.length < 10 ? 'disabled' : ''}>ä¸‹ä¸€é¡µ â†’</button></div>`;
                }
                musicContainer.innerHTML = html;

                document.querySelectorAll('#music-results-container .music-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const rid = this.dataset.rid;
                        const name = this.dataset.name;
                        const artist = this.dataset.artist;
                        playMusic(rid, name, artist);
                    });
                });

                const prevBtn = document.getElementById('music-prev-page');
                const nextBtn = document.getElementById('music-next-page');
                if (prevBtn) prevBtn.addEventListener('click', () => { if (page > 1) searchMusic(keyword, page - 1); });
                if (nextBtn) nextBtn.addEventListener('click', () => { if (list.length >= 10) searchMusic(keyword, page + 1); });
            }

            // æ¯æ—¥æ¨è
            function loadDailyRecommendations() {
                const shuffled = recommendArtists.sort(() => 0.5 - Math.random());
                const mainArtist = shuffled[0];
                const url = `${MUSIC_API.search}?key=${encodeURIComponent(mainArtist)}&pn=1&rn=20`;
                fetch(url)
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.data && data.data.list) {
                            renderDailyRecommendations(data.data.list.slice(0, 10));
                        } else {
                            setTimeout(() => loadDailyRecommendations(), 500);
                        }
                    })
                    .catch(err => console.error('åŠ è½½æ¯æ—¥æ¨èå¤±è´¥', err));
            }

            function renderDailyRecommendations(list) {
                const dailyContainer = document.getElementById('daily-recommendations');
                if (!dailyContainer) return;
                if (!list || list.length === 0) {
                    dailyContainer.innerHTML = '<div class="empty-message">æš‚æ— æ¨è</div>';
                    return;
                }
                let html = '';
                list.slice(0, 10).forEach(item => {
                    const rid = item.rid;
                    const coverUrl = getCoverUrl(rid);
                    html += `
                        <div class="music-item" data-rid="${rid}" data-name="${item.name.replace(/"/g, '&quot;')}" data-artist="${item.artist.replace(/"/g, '&quot;')}">
                            <div class="music-cover"><img src="${coverUrl}" alt="cover" onerror="this.style.display='none';this.parentNode.innerHTML='ğŸµ';"></div>
                            <div class="music-info">
                                <div class="music-title">${item.name}</div>
                                <div class="music-artist">${item.artist}</div>
                            </div>
                            <!-- æ’­æ”¾å›¾æ ‡å·²ç§»é™¤ -->
                        </div>
                    `;
                });
                dailyContainer.innerHTML = html;

                document.querySelectorAll('#daily-recommendations .music-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const rid = this.dataset.rid;
                        const name = this.dataset.name;
                        const artist = this.dataset.artist;
                        playMusic(rid, name, artist);
                    });
                });
            }

            function refreshDaily() {
                loadDailyRecommendations();
            }

            // æ’­æ”¾éŸ³ä¹
            function playMusic(rid, name, artist) {
                floatingPlayer.classList.add('show');
                playerTitle.innerText = name;
                playerArtist.innerText = artist;
                const urlApi = `${MUSIC_API.url}?mid=${rid}&type=music&br=128kmp3`;
                fetch(urlApi)
                    .then(res => res.json())
                    .then(json => {
                        const realUrl = toHttp(json.data.url);
                        audioPlayer.src = realUrl;
                        audioPlayer.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥', e));
                    })
                    .catch(err => {
                        alert('è·å–æ’­æ”¾åœ°å€å¤±è´¥');
                        console.error(err);
                    });
            }

            closePlayerBtn.addEventListener('click', () => {
                audioPlayer.pause();
                audioPlayer.src = '';
                floatingPlayer.classList.remove('show');
            });

            // ========== åˆ†åŒºæœç´¢å¤„ç† ==========
            function handleSearch(keyword) {
                if (!keyword.trim()) {
                    resetToHome();
                    return;
                }

                searchActive = true;

                if (currentCategory === 'music') {
                    // éŸ³ä¹åˆ†åŒºï¼šéšè—æ¯æ—¥æ¨èå¤´éƒ¨ï¼ˆä½†ä¿ç•™æ¢ä¸€æ‰¹æŒ‰é’®ï¼Ÿæ ¹æ®éœ€æ±‚ï¼Œæˆ‘ä»¬éšè—æ¯æ—¥æ¨èåŒºåŸŸï¼‰
                    const dailyHeader = document.getElementById('dailyHeader');
                    const dailyRec = document.getElementById('daily-recommendations');
                    if (dailyHeader) dailyHeader.style.display = 'none';
                    if (dailyRec) dailyRec.style.display = 'none';
                    
                    // æ˜¾ç¤ºæœç´¢ç»“æœå®¹å™¨
                    const musicContainer = document.getElementById('music-results-container');
                    if (musicContainer) {
                        musicContainer.style.display = 'block';
                    }
                    
                    searchMusic(keyword, 1);
                } else {
                    // ééŸ³ä¹åˆ†åŒºï¼šæœç´¢æœ¬åœ°apps
                    let filtered = apps.filter(app => app.category === currentCategory);
                    if (PLATFORM_SPECIFIC_CATEGORIES.includes(currentCategory)) {
                        filtered = filtered.filter(app => app.platform === devicePlatform);
                    }
                    const results = filtered.filter(app => 
                        app.name.toLowerCase().includes(keyword.toLowerCase())
                    );
                    renderLocalResults(results);
                }
            }

            function renderLocalResults(results) {
                let html = '';
                if (results.length === 0) {
                    html = '<div class="empty-message">æš‚æ— åŒ¹é…æ–‡ä»¶</div>';
                } else {
                    results.forEach(app => {
                        const platformIcon = app.platform === 'ios' ? 'ğŸ' : 'ğŸ¤–';
                        const platformTag = app.platform === 'ios' ? 'iOS' : 'Android';
                        html += `
                            <div class="app-card" data-id="${app.id}">
                                <div class="app-icon">${platformIcon}</div>
                                <div class="app-info" onclick="window.open('${app.url}', '_blank')">
                                    <div class="app-name">${app.name} <span class="app-platform">${platformTag}</span></div>
                                    <div class="app-url-preview">${app.url}</div>
                                    <div style="margin-top: 6px;"><span class="download-badge ${themeClass}">ä¸‹è½½</span></div>
                                </div>
                            </div>
                        `;
                    });
                }
                grid.innerHTML = html;
            }

            // è¿”å›ä¸»é¡µ (å–æ¶ˆæœç´¢)
            function resetToHome() {
                searchActive = false;
                searchInput.value = '';
                renderGrid(); // é‡æ–°æ¸²æŸ“å½“å‰åˆ†åŒºä¸»é¡µ
            }

            // ========== æ¸²æŸ“ç½‘æ ¼ ==========
            function renderGrid() {
                let filtered = apps.filter(app => app.category === currentCategory);
                if (PLATFORM_SPECIFIC_CATEGORIES.includes(currentCategory)) {
                    filtered = filtered.filter(app => app.platform === devicePlatform);
                }

                let html = '';

                if (currentCategory === 'music') {
                    // éŸ³ä¹åˆ†åŒºï¼šåªæ˜¾ç¤ºæ¯æ—¥æ¨èï¼Œæœç´¢ç»“æœåŒºåŸŸéšè—
                    html += `
                        <div class="music-section">
                            <div class="daily-header" id="dailyHeader">
                                <div class="daily-title">ğŸµ æ¯æ—¥æ¨è</div>
                                <div class="refresh-daily ${themeClass}" id="refreshDailyBtn">â†» æ¢ä¸€æ‰¹</div>
                            </div>
                            <div id="daily-recommendations" class="loading">åŠ è½½æ¨èä¸­...</div>
                            
                            <!-- æœç´¢ç»“æœåŒºåŸŸé»˜è®¤éšè— -->
                            <div id="music-results-container" style="display: none;"></div>
                        </div>
                    `;
                    grid.innerHTML = html;
                    loadDailyRecommendations();
                    document.getElementById('refreshDailyBtn').addEventListener('click', refreshDaily);
                } else {
                    if (filtered.length === 0) {
                        html = `<div class="empty-message">æš‚æ— æ–‡ä»¶</div>`;
                    } else {
                        filtered.forEach(app => {
                            const platformIcon = app.platform === 'ios' ? 'ğŸ' : 'ğŸ¤–';
                            const platformTag = app.platform === 'ios' ? 'iOS' : 'Android';
                            html += `
                                <div class="app-card" data-id="${app.id}">
                                    <div class="app-icon">${platformIcon}</div>
                                    <div class="app-info" onclick="window.open('${app.url}', '_blank')">
                                        <div class="app-name">${app.name} <span class="app-platform">${platformTag}</span></div>
                                        <div class="app-url-preview">${app.url}</div>
                                        <div style="margin-top: 6px;"><span class="download-badge ${themeClass}">ä¸‹è½½</span></div>
                                    </div>
                                </div>
                            `;
                        });
                    }
                    grid.innerHTML = html;
                }
            }

            // ========== æœç´¢æ¡†å›è½¦äº‹ä»¶ ==========
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const keyword = searchInput.value.trim();
                    handleSearch(keyword);
                    // æœç´¢å®Œæˆåæ¸…ç©ºè¾“å…¥æ¡†
                    searchInput.value = '';
                }
            });

            // å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
            searchCancelBtn.addEventListener('click', () => {
                resetToHome();
            });

            // ========== åº•éƒ¨å¯¼èˆªåˆ‡æ¢ ==========
            function setActiveNav(cat) {
                navItems.forEach(item => {
                    item.classList.remove('active', 'ios-theme', 'android-theme');
                    if (item.dataset.cat === cat) {
                        item.classList.add('active', themeClass);
                    }
                });
            }

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    currentCategory = item.dataset.cat;
                    setActiveNav(currentCategory);
                    renderGrid();
                    searchInput.value = '';
                    searchActive = false;
                });
            });

            // åˆå§‹åŒ–
            setActiveNav(currentCategory);
            renderGrid();
        })();
    </script>
</body>
</html>