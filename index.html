<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>æ”¶è—ç®¡ç†å™¨ Â· äº”é”®åŠ å®½ Â· æ‰å¹³å›¾æ ‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Google Sans', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: #000000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 12px 8px 90px;
            color: #ffffff;
        }

        .phone-container {
            max-width: 320px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        /* é¡¶éƒ¨ */
        .header-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            max-width: 320px;
        }

        .search-wrapper {
            flex: 1;
            min-width: 0;
            cursor: pointer;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 30px;
            padding: 8px 12px;
            width: 100%;
        }

        .search-box span {
            font-size: 1.2rem;
            margin-right: 6px;
            color: #888;
        }

        .search-box input {
            background: transparent;
            border: none;
            color: white;
            font-size: 0.9rem;
            width: 100%;
            outline: none;
        }

        .add-button {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 30px;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            white-space: nowrap;
            min-width: 70px;
        }

        .add-button:active {
            background: #2a2a2a;
        }

        /* å ä½ */
        .welcome-row {
            margin: 4px 0 8px;
            width: 100%;
            height: 4px;
        }

        /* å¡ç‰‡ç½‘æ ¼ */
        .cards-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            max-width: 300px;
            margin: 8px auto;
        }

        .black-card {
            background: #121212;
            border-radius: 28px;
            padding: 16px 12px 12px;
            border: 1px solid #2a2a2a;
            display: flex;
            flex-direction: column;
            width: 100%;
            position: relative;
        }

        .card-image {
            width: 120px;
            height: 120px;
            border-radius: 24px;
            background: #1f1f1f;
            overflow: hidden;
            margin: 0 auto 12px;
            border: 1px solid #2c2c2c;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .card-image:active {
            transform: scale(0.96);
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #444;
            background: #1a1a1a;
            width: 100%;
            height: 100%;
        }

        .image-placeholder span {
            font-size: 2rem;
            opacity: 0.4;
        }

        .card-name {
            font-weight: 500;
            font-size: 1.1rem;
            color: #f0f0f0;
            margin-bottom: 4px;
            text-align: center;
            padding-right: 40px;
        }

        .card-domain {
            font-size: 0.75rem;
            color: #777;
            margin-bottom: 8px;
            text-align: center;
            word-break: break-all;
            padding-right: 40px;
        }

        /* å³ä¸‹è§’æ“ä½œåŒº */
        .card-corner-actions {
            position: absolute;
            bottom: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 30px;
            padding: 4px;
            border: 1px solid #3a3a3a;
        }

        .corner-btn {
            background: transparent;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: #ccc;
            cursor: pointer;
            transition: all 0.1s;
        }

        .corner-btn:active {
            background: #2a2a2a;
            color: white;
        }

        .corner-btn.delete-btn:active {
            background: #8b1e1e;
            color: white;
        }

        .empty-message {
            text-align: center;
            padding: 40px 20px;
            color: #555;
            background: #0a0a0a;
            border-radius: 36px;
            border: 2px dashed #2a2a2a;
        }

        /* åº•éƒ¨å¯¼èˆª - åŠ å®½åŠ å¤§ï¼Œå¸¦æ‰å¹³åŒ–å›¾æ ‡ */
        .bottom-nav {
            position: fixed;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 340px;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 40px;
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            padding: 8px 8px;
            z-index: 100;
            gap: 4px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: #8e8e93;
            font-size: 0.8rem;
            font-weight: 500;
            padding: 8px 0;
            border-radius: 32px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
            min-width: 52px;
            max-width: 70px;
            height: 48px;
        }

        .nav-item.active {
            color: white;
            background: rgba(255, 255, 255, 0.15);
            font-weight: 600;
            backdrop-filter: blur(5px);
        }

        /* å¼¹çª— */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-card {
            background: #1a1a1a;
            width: 90%;
            max-width: 300px;
            border-radius: 32px;
            padding: 24px 20px;
            border: 1px solid #333;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-card h2 {
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 20px;
            text-align: center;
        }

        .input-field {
            margin-bottom: 16px;
        }

        .input-field label {
            display: block;
            font-size: 0.75rem;
            color: #aaa;
            margin-bottom: 4px;
        }

        .input-field input, .input-field select {
            width: 100%;
            padding: 12px 16px;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 30px;
            font-size: 0.9rem;
            color: white;
            outline: none;
        }

        .url-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .url-input-row input {
            flex: 1;
        }
        
        .fetch-btn {
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 30px;
            padding: 12px 16px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            min-width: 70px;
        }
        
        .fetch-btn:active {
            background: #4a4a4a;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 40px;
            border: 1px solid #444;
            background: transparent;
            color: #ccc;
            cursor: pointer;
            min-width: 100px;
        }

        .modal-btn.primary {
            background: #2a2a2a;
            color: white;
            border-color: #666;
        }

        .modal-btn.primary:active {
            background: #3a3a3a;
        }

        /* å¯¼å…¥åŒºåŸŸ */
        .import-area {
            margin: 16px 0 8px;
            border-top: 1px solid #333;
            padding-top: 16px;
        }

        .import-btn-large {
            width: 100%;
            padding: 16px !important;
            font-size: 1.1rem !important;
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 40px;
            color: white;
            cursor: pointer;
            margin: 8px 0;
            font-weight: 500;
        }

        .import-btn-large:active {
            background: #3a3a3a;
        }

        .file-input-wrapper {
            margin-bottom: 12px;
        }

        .file-input-wrapper input {
            background: #1a1a1a;
            padding: 10px;
        }

        /* æœç´¢é¡µé¢ */
        .search-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            z-index: 200;
            display: none;
            flex-direction: column;
            padding: 16px 12px 0;
            overflow-y: auto;
        }

        .search-overlay.show {
            display: flex;
        }

        .search-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            background: #000;
            padding: 8px 0;
        }

        .back-btn {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 30px;
            padding: 8px 16px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .search-input-box {
            flex: 1;
            display: flex;
            align-items: center;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 30px;
            padding: 8px 12px;
        }

        .search-input-box input {
            background: transparent;
            border: none;
            color: white;
            font-size: 1rem;
            width: 100%;
            outline: none;
        }

        .search-results-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
            width: 100%;
            flex: 1;
            padding-bottom: 16px;
        }

        .search-card {
            background: #121212;
            border-radius: 28px;
            padding: 12px;
            border: 1px solid #2a2a2a;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-card-checkbox {
            width: 24px;
            height: 24px;
            accent-color: #1a73e8;
        }

        .search-card-image {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: #1f1f1f;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
        }

        .search-card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .search-card-info {
            flex: 1;
            cursor: pointer;
        }

        .search-card-name {
            font-weight: 500;
            font-size: 1rem;
            color: #f0f0f0;
            margin-bottom: 4px;
        }

        .search-card-url {
            font-size: 0.7rem;
            color: #777;
        }

        .search-actions-bar {
            background: #0c0c0c;
            border-top: 1px solid #333;
            padding: 12px;
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: auto;
            border-radius: 30px 30px 0 0;
            position: sticky;
            bottom: 0;
            left: 0;
            width: 100%;
            flex-wrap: wrap;
        }

        .search-action-btn {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 40px;
            padding: 10px 16px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            flex: 1;
            min-width: 80px;
            max-width: 120px;
        }

        .search-action-btn.primary {
            background: #1a73e8;
            border-color: #1a73e8;
        }

        .search-hint {
            color: #666;
            font-size: 0.7rem;
            margin: 4px 0;
            text-align: center;
            background: #0a0a0a;
            padding: 4px;
            border-radius: 20px;
        }

        /* ç‰ˆæœ¬å·å¼¹çª— */
        .version-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 40px;
            font-size: 1rem;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border: 1px solid #555;
        }
        .version-toast.show {
            opacity: 1;
        }

        .fetch-loading {
            color: #1a73e8;
            font-size: 0.75rem;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="version-toast" id="versionToast">æ”¶è—ç®¡ç†å™¨ Â· äº”é”®åŠ å®½ Â· æ‰å¹³å›¾æ ‡</div>

    <div class="phone-container">
        <div class="header-row">
            <div class="search-wrapper" id="openSearchBtn">
                <div class="search-box">
                    <span>ğŸ”</span>
                    <input type="text" placeholder="æœç´¢" readonly value="ç‚¹æˆ‘æœç´¢å…¨éƒ¨">
                </div>
            </div>
            <div class="add-button" id="openAddModalBtn">
                <span>+</span> æ·»åŠ 
            </div>
        </div>

        <div class="welcome-row"></div>
        <div class="cards-grid" id="cardsGrid"></div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª - äº”ä¸ªæ‰å¹³åŒ–æŒ‰é’®ï¼Œç§»é™¤åˆ†å‘ï¼ŒåŠ å…¥å¯¹åº”æ‰å¹³å›¾æ ‡ -->
    <div class="bottom-nav" id="bottomNav">
        <button class="nav-item" data-cat="apps">ğŸ“± åº”ç”¨</button>
        <button class="nav-item" data-cat="games">ğŸ® æ¸¸æˆ</button>
        <button class="nav-item" data-cat="movies">ğŸ¬ ç”µå½±</button>
        <button class="nav-item" data-cat="books">ğŸ“˜ å›¾ä¹¦</button>
        <button class="nav-item" data-cat="music">ğŸµ éŸ³ä¹</button>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘å¼¹çª— - ç§»é™¤åˆ†å‘é€‰é¡¹ -->
    <div class="modal" id="itemModal">
        <div class="modal-card">
            <h2 id="modalTitle">æ·»åŠ é¡¹ç›®</h2>
            <div class="input-field">
                <label>åç§°</label>
                <input type="text" id="itemName" placeholder="åº”ç”¨/æ¸¸æˆ/æ–‡ä»¶åç§°">
            </div>
            <div class="input-field">
                <label>ç½‘å€/è·¯å¾„</label>
                <div class="url-input-row">
                    <input type="url" id="itemUrl" placeholder="ä¾‹å¦‚: example.com æˆ– æ–‡ä»¶é“¾æ¥">
                    <button class="fetch-btn" id="fetchInfoBtn">è·å–ä¿¡æ¯</button>
                </div>
                <div id="fetchStatus" class="fetch-loading"></div>
            </div>
            <div class="input-field">
                <label>åˆ†ç±»</label>
                <select id="itemCategory">
                    <option value="apps">ğŸ“± åº”ç”¨</option>
                    <option value="games">ğŸ® æ¸¸æˆ</option>
                    <option value="movies">ğŸ¬ ç”µå½±</option>
                    <option value="books">ğŸ“˜ å›¾ä¹¦</option>
                    <option value="music">ğŸµ éŸ³ä¹</option>
                </select>
            </div>
            <div class="input-field">
                <label>å›¾æ ‡</label>
                <input type="file" id="itemImage" accept="image/*">
                <div style="color:#777;font-size:0.65rem;margin-top:4px;">å¯é€‰ï¼Œç‚¹å‡»å›¾ç‰‡5æ¬¡ä¹Ÿå¯æ›´æ¢</div>
            </div>
            <div class="import-area">
                <div class="file-input-wrapper">
                    <input type="file" id="importFileInput" accept=".html,.htm" style="width:100%;">
                </div>
                <button class="modal-btn primary import-btn-large" id="importFromAddBtn">ğŸ“‚ æ‰§è¡Œå¯¼å…¥å¹¶åˆå¹¶</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelModalBtn">å–æ¶ˆ</button>
                <button class="modal-btn primary" id="saveItemBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æœç´¢é¡µé¢ - æ›´æ–°æç¤ºæ–‡å­— -->
    <div class="search-overlay" id="searchOverlay">
        <div class="search-header">
            <button class="back-btn" id="closeSearchBtn">â† è¿”å›</button>
            <div class="search-input-box">
                <span>ğŸ”</span>
                <input type="text" id="searchInput" placeholder="æœç´¢æ‰€æœ‰æ”¶è—...">
            </div>
        </div>
        <div class="search-hint" id="searchHint">âœ¨ å…³é”®è¯æˆ–åˆ†åŒºå(ğŸ“±åº”ç”¨/ğŸ®æ¸¸æˆ/ğŸ¬ç”µå½±/ğŸ“˜å›¾ä¹¦/ğŸµéŸ³ä¹) å…¨å±€æœç´¢</div>
        <div class="search-results-grid" id="searchResultsGrid"></div>
        <div class="search-actions-bar">
            <button class="search-action-btn" id="selectAllBtn">å…¨é€‰</button>
            <button class="search-action-btn" id="deselectAllBtn">å–æ¶ˆ</button>
            <button class="search-action-btn primary" id="exportFullBtn">å¯¼å‡ºå®Œæ•´ç‰ˆ</button>
        </div>
    </div>

    <script>
        (function() {
            let items = [];
            let currentCategory = 'apps';
            let editingId = null;
            let selectedIds = new Set();
            let appsClickCount = 0;
            let versionTimer = null;

            // äº”è¿å¯¼å‡ºè®¡æ•°å™¨
            let exportClickCount = 0;
            let exportTimer = null;

            // å›¾ç‰‡äº”è¿å‡»è®¡æ•°å™¨
            let imageClickCounters = new Map();

            const categoryMap = {
                'ğŸ“±åº”ç”¨': 'apps', 'åº”ç”¨': 'apps', 'app': 'apps', 'apps': 'apps',
                'ğŸ®æ¸¸æˆ': 'games', 'æ¸¸æˆ': 'games', 'game': 'games', 'games': 'games',
                'ğŸ¬ç”µå½±': 'movies', 'ç”µå½±': 'movies', 'movie': 'movies', 'movies': 'movies',
                'ğŸ“˜å›¾ä¹¦': 'books', 'å›¾ä¹¦': 'books', 'book': 'books', 'books': 'books',
                'ğŸµéŸ³ä¹': 'music', 'éŸ³ä¹': 'music', 'music': 'music'
            };

            // æ–‡ä»¶æ‰©å±•åæ˜ å°„
            const extCategoryMap = {
                'txt': 'books', 'pdf': 'books', 'epub': 'books', 'mobi': 'books', 'azw3': 'books', 'doc': 'books', 'docx': 'books',
                'mp3': 'music', 'aac': 'music', 'flac': 'music', 'wav': 'music', 'ogg': 'music', 'm4a': 'music',
                'mp4': 'movies', 'avi': 'movies', 'mkv': 'movies', 'mov': 'movies', 'wmv': 'movies', 'flv': 'movies', 'webm': 'movies',
                'apk': 'apps', 'ipa': 'apps'
            };

            try {
                const saved = localStorage.getItem('ultimate_final_items_v3');
                if (saved) items = JSON.parse(saved);
            } catch (e) { items = []; }

            // âŒ ç§»é™¤é¢„è®¾ç¤ºä¾‹æ•°æ®ï¼šåˆ é™¤ presets ä»¥åŠè°ƒç”¨å‡½æ•°
            // (åŸå…ˆçš„ presetItems å’Œ addPresetItemsIfNeeded å…¨éƒ¨ç§»é™¤ï¼Œä¿ç•™ç©ºæ•°æ®æˆ–å·²æœ‰ç”¨æˆ·æ•°æ®)
            // ä½†ä¸ºäº†ç¬¬ä¸€æ¬¡æ‰“å¼€ä¸ç©ºå¾—å¯æ€•ï¼Œå¯é€‰ç•™ä¸€æ¡æç¤ºï¼Œä½†ä¸¥æ ¼åˆ é™¤ç¤ºä¾‹ â†’ åˆå§‹ items ä¸ºç©ºæ•°ç»„ï¼Œå¦‚æœæœ¬åœ°æ— æ•°æ®å°±ç©ºç€ã€‚
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ï¼Œitems = []ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€ã€‚
            if (!localStorage.getItem('ultimate_final_items_v3')) {
                items = [];   // ç¡®ä¿å®Œå…¨ç©ºç™½ï¼Œæ— é¢„è®¾
            }

            function saveItems() {
                try { localStorage.setItem('ultimate_final_items_v3', JSON.stringify(items)); } catch (e) {}
            }

            // DOM
            const grid = document.getElementById('cardsGrid');
            const modal = document.getElementById('itemModal');
            const modalTitle = document.getElementById('modalTitle');
            const itemName = document.getElementById('itemName');
            const itemUrl = document.getElementById('itemUrl');
            const itemCategory = document.getElementById('itemCategory');
            const itemImage = document.getElementById('itemImage');
            const cancelBtn = document.getElementById('cancelModalBtn');
            const saveBtn = document.getElementById('saveItemBtn');
            const addBtn = document.getElementById('openAddModalBtn');
            const fetchInfoBtn = document.getElementById('fetchInfoBtn');
            const fetchStatus = document.getElementById('fetchStatus');
            const navItems = document.querySelectorAll('.nav-item');
            const openSearchBtn = document.getElementById('openSearchBtn');
            const closeSearchBtn = document.getElementById('closeSearchBtn');
            const searchOverlay = document.getElementById('searchOverlay');
            const searchInput = document.getElementById('searchInput');
            const searchResultsGrid = document.getElementById('searchResultsGrid');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const exportFullBtn = document.getElementById('exportFullBtn');
            const searchHint = document.getElementById('searchHint');
            const versionToast = document.getElementById('versionToast');
            const importFileInput = document.getElementById('importFileInput');
            const importFromAddBtn = document.getElementById('importFromAddBtn');

            // ç‰ˆæœ¬å·è§¦å‘
            function showVersion() {
                versionToast.classList.add('show');
                setTimeout(() => versionToast.classList.remove('show'), 2000);
            }

            const appsNavBtn = document.querySelector('.nav-item[data-cat="apps"]');
            if (appsNavBtn) {
                appsNavBtn.addEventListener('click', () => {
                    appsClickCount++;
                    if (versionTimer) clearTimeout(versionTimer);
                    versionTimer = setTimeout(() => appsClickCount = 0, 3000);
                    if (appsClickCount >= 5) { showVersion(); appsClickCount = 0; }
                });
            }

            // æ™ºèƒ½åˆ†ç±»
            function guessCategoryFromUrl(url, name) {
                const lowerUrl = url.toLowerCase();
                const lowerName = name.toLowerCase();
                
                for (const [ext, cat] of Object.entries(extCategoryMap)) {
                    if (lowerUrl.endsWith('.' + ext) || lowerName.includes('.' + ext) || lowerUrl.includes('.' + ext + '?')) {
                        return cat;
                    }
                }
                
                if (lowerUrl.includes('play.google.com') || lowerUrl.includes('appstore') || lowerUrl.includes('apk') || lowerUrl.includes('ipa')) {
                    return 'apps';
                }
                
                if (lowerUrl.includes('game') || lowerName.includes('æ¸¸æˆ') || lowerName.includes('game')) {
                    return 'games';
                }
                
                return null;
            }

            // æ¸…ç†åç§°åç¼€
            function cleanName(name, url) {
                if (!name) return name;
                
                const patterns = [
                    /[\s-]+APK[\s-]+for[\s-]+Android[\s-]+Download[\s-]+-.*$/i,
                    /[\s-]+IPA[\s-]+for[\s-]+iOS[\s-]+Download[\s-]+-.*$/i,
                    /[\s-]+for[\s-]+Android[\s-]+Download.*$/i,
                    /[\s-]+for[\s-]+iOS[\s-]+Download.*$/i,
                    /[\s-]+Download.*$/i,
                    /[\s-]+-\s*LOADLY\.IO.*$/i,
                    /[\s-]+LOADLY\.IO.*$/i
                ];
                
                let cleaned = name;
                for (const pattern of patterns) {
                    cleaned = cleaned.replace(pattern, '');
                }
                
                return cleaned.trim() || name;
            }

            async function fetchWebsiteInfo(url) {
                const fullUrl = ensureHttps(url);
                try {
                    fetchStatus.innerText = 'æ­£åœ¨è·å–ä¿¡æ¯...';
                    
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(fullUrl);
                    
                    try {
                        const response = await fetch(proxyUrl);
                        if (response.ok) {
                            const html = await response.text();
                            
                            const titleMatch = html.match(/<title[^>]*>([^<]+)<\/title>/i);
                            if (titleMatch && titleMatch[1]) {
                                let rawName = titleMatch[1].trim();
                                rawName = cleanName(rawName, fullUrl);
                                itemName.value = rawName;
                            }
                            
                            const faviconMatch = html.match(/<link[^>]*rel=["'](?:shortcut )?icon["'][^>]*href=["']([^"']+)["']/i);
                            if (faviconMatch && faviconMatch[1]) {
                                let faviconUrl = faviconMatch[1];
                                if (faviconUrl.startsWith('//')) faviconUrl = 'https:' + faviconUrl;
                                else if (faviconUrl.startsWith('/')) {
                                    const urlObj = new URL(fullUrl);
                                    faviconUrl = urlObj.origin + faviconUrl;
                                } else if (!faviconUrl.startsWith('http')) {
                                    const urlObj = new URL(fullUrl);
                                    faviconUrl = urlObj.origin + '/' + faviconUrl;
                                }
                                
                                try {
                                    const iconResponse = await fetch(proxyUrl.replace(/raw\?url=/, 'raw?url=') + encodeURIComponent(faviconUrl));
                                    if (iconResponse.ok) {
                                        const blob = await iconResponse.blob();
                                        const reader = new FileReader();
                                        reader.onload = (e) => {
                                            window.fetchedImageData = e.target.result;
                                            fetchStatus.innerText = 'âœ“ å·²è·å–å›¾æ ‡å’Œåç§°';
                                        };
                                        reader.readAsDataURL(blob);
                                    } else {
                                        fetchStatus.innerText = 'âœ“ å·²è·å–åç§°ï¼Œä½†æ— æ³•è·å–å›¾æ ‡';
                                    }
                                } catch {
                                    fetchStatus.innerText = 'âœ“ å·²è·å–åç§°ï¼Œå›¾æ ‡è·å–å¤±è´¥';
                                }
                            } else {
                                fetchStatus.innerText = 'âœ“ å·²è·å–åç§°';
                            }
                            
                            const guessedCat = guessCategoryFromUrl(fullUrl, itemName.value);
                            if (guessedCat) {
                                itemCategory.value = guessedCat;
                                fetchStatus.innerText += ' (å·²æ¨èåˆ†ç±»)';
                            }
                        } else {
                            try {
                                const urlObj = new URL(fullUrl);
                                itemName.value = cleanName(urlObj.hostname.replace('www.', ''), fullUrl);
                                fetchStatus.innerText = 'ä½¿ç”¨åŸŸåä½œä¸ºåç§°';
                            } catch {
                                fetchStatus.innerText = 'æ— æ³•è·å–ä¿¡æ¯';
                            }
                        }
                    } catch {
                        try {
                            const urlObj = new URL(fullUrl);
                            itemName.value = cleanName(urlObj.hostname.replace('www.', ''), fullUrl);
                            fetchStatus.innerText = 'ä½¿ç”¨åŸŸåä½œä¸ºåç§°';
                        } catch {
                            fetchStatus.innerText = 'æ— æ³•è·å–ä¿¡æ¯';
                        }
                    }
                } catch (err) {
                    fetchStatus.innerText = 'è·å–å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¡«å†™';
                }
            }

            fetchInfoBtn.addEventListener('click', () => {
                const url = itemUrl.value.trim();
                if (!url) { alert('è¯·è¾“å…¥ç½‘å€'); return; }
                fetchWebsiteInfo(url);
            });

            function ensureHttps(url) {
                url = url.trim();
                if (url === '') return url;
                if (url.match(/^https?:\/\//i)) return url;
                return 'https://' + url;
            }

            function renderGrid() {
                const filtered = items.filter(item => item.category === currentCategory);
                if (filtered.length === 0) {
                    grid.innerHTML = '<div class="empty-message">âš« ç‚¹å‡»"æ·»åŠ "æŒ‰é’®å¼€å§‹æ”¶è—</div>';
                    return;
                }

                let html = '';
                filtered.forEach(item => {
                    let domain = '';
                    try { domain = new URL(item.url).hostname; } catch { domain = item.url; }
                    
                    let imageHtml;
                    if (item.imageData) {
                        imageHtml = `<img src="${item.imageData}" alt="">`;
                    } else {
                        // æ ¹æ®åˆ†ç±»æ˜¾ç¤ºæ‰å¹³å ä½ç¬¦å›¾æ ‡
                        let placeholderIcon = 'â¬›'; // é»˜è®¤
                        if (item.category === 'apps') placeholderIcon = 'ğŸ“±';
                        else if (item.category === 'games') placeholderIcon = 'ğŸ®';
                        else if (item.category === 'movies') placeholderIcon = 'ğŸ¬';
                        else if (item.category === 'books') placeholderIcon = 'ğŸ“˜';
                        else if (item.category === 'music') placeholderIcon = 'ğŸµ';
                        imageHtml = `<div class="image-placeholder"><span>${placeholderIcon}</span></div>`;
                    }
                    
                    html += `
                        <div class="black-card" data-id="${item.id}">
                            <div class="card-image image-clickable" data-id="${item.id}">
                                ${imageHtml}
                            </div>
                            <div class="card-name">${item.name}</div>
                            <div class="card-domain">${domain}</div>
                            <div class="card-corner-actions">
                                <button class="corner-btn edit-btn" data-id="${item.id}">âœï¸</button>
                                <button class="corner-btn delete-btn" data-id="${item.id}">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `;
                });
                grid.innerHTML = html;

                document.querySelectorAll('.image-clickable').forEach(imgDiv => {
                    const id = imgDiv.dataset.id;
                    let clickCount = 0;
                    let timer = null;
                    
                    imgDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        clickCount++;
                        if (timer) clearTimeout(timer);
                        timer = setTimeout(() => { clickCount = 0; }, 3000);
                        
                        if (clickCount >= 5) {
                            clickCount = 0;
                            const item = items.find(i => i.id === id);
                            if (item) {
                                const input = document.createElement('input');
                                input.type = 'file';
                                input.accept = 'image/*';
                                input.onchange = (e) => {
                                    const file = e.target.files[0];
                                    if (file) {
                                        const reader = new FileReader();
                                        reader.onload = (re) => {
                                            item.imageData = re.target.result;
                                            saveItems();
                                            renderGrid();
                                        };
                                        reader.readAsDataURL(file);
                                    }
                                };
                                input.click();
                            }
                        }
                    });
                });

                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.id;
                        const item = items.find(i => i.id === id);
                        if (item) {
                            editingId = id;
                            modalTitle.innerText = 'ç¼–è¾‘é¡¹ç›®';
                            itemName.value = item.name || '';
                            itemUrl.value = item.url || '';
                            itemCategory.value = item.category || 'apps';
                            itemImage.value = '';
                            fetchStatus.innerText = '';
                            modal.classList.add('show');
                        }
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.id;
                        if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
                            items = items.filter(i => i.id !== id);
                            saveItems();
                            renderGrid();
                        }
                    });
                });

                document.querySelectorAll('.black-card').forEach(card => {
                    card.addEventListener('click', function(e) {
                        if (e.target.tagName === 'BUTTON' || e.target.classList.contains('image-clickable')) return;
                        const id = this.dataset.id;
                        const item = items.find(i => i.id === id);
                        if (item && item.url) window.open(item.url, '_blank');
                    });
                });
            }

            addBtn.addEventListener('click', () => {
                editingId = null;
                modalTitle.innerText = 'æ·»åŠ é¡¹ç›®';
                itemName.value = '';
                itemUrl.value = '';
                itemCategory.value = currentCategory;
                itemImage.value = '';
                importFileInput.value = '';
                fetchStatus.innerText = '';
                window.fetchedImageData = null;
                modal.classList.add('show');
            });

            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                window.fetchedImageData = null;
            });

            saveBtn.addEventListener('click', () => {
                let name = itemName.value.trim();
                let url = itemUrl.value.trim();
                const category = itemCategory.value;
                
                if (!name) { alert('è¯·è¾“å…¥åç§°'); return; }
                if (!url) { alert('è¯·è¾“å…¥ç½‘å€/è·¯å¾„'); return; }
                
                url = ensureHttps(url);
                name = cleanName(name, url);

                if (window.fetchedImageData) {
                    saveItem(name, url, category, window.fetchedImageData);
                    window.fetchedImageData = null;
                } else {
                    const file = itemImage.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => saveItem(name, url, category, e.target.result);
                        reader.readAsDataURL(file);
                    } else {
                        saveItem(name, url, category, null);
                    }
                }
            });

            function saveItem(name, url, category, imageData) {
                if (editingId) {
                    const idx = items.findIndex(i => i.id === editingId);
                    if (idx !== -1) {
                        items[idx].name = name;
                        items[idx].url = url;
                        items[idx].category = category;
                        if (imageData) items[idx].imageData = imageData;
                    }
                } else {
                    items.push({
                        id: Date.now() + '-' + Math.random().toString(36).substr(2, 6),
                        name, url, category, imageData
                    });
                }
                saveItems();
                if (category !== currentCategory) {
                    currentCategory = category;
                    setActiveNav(category);
                }
                renderGrid();
                modal.classList.remove('show');
                fetchStatus.innerText = '';
                window.fetchedImageData = null;
            }

            function setActiveNav(cat) {
                navItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.cat === cat);
                });
            }

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    currentCategory = item.dataset.cat;
                    setActiveNav(currentCategory);
                    renderGrid();
                });
            });

            // æœç´¢åŠŸèƒ½ (å«æ‰å¹³å›¾æ ‡è¯†åˆ«)
            function getFilteredResults(keyword) {
                keyword = keyword.toLowerCase().trim();
                
                // æ‰å¹³åŒ–åˆ†ç±»å…³é”®è¯
                if (keyword.includes('ğŸ“±') || keyword.includes('åº”ç”¨') || keyword === 'apps') return items.filter(item => item.category === 'apps');
                if (keyword.includes('ğŸ®') || keyword.includes('æ¸¸æˆ') || keyword === 'games') return items.filter(item => item.category === 'games');
                if (keyword.includes('ğŸ¬') || keyword.includes('ç”µå½±') || keyword === 'movies') return items.filter(item => item.category === 'movies');
                if (keyword.includes('ğŸ“˜') || keyword.includes('å›¾ä¹¦') || keyword === 'books') return items.filter(item => item.category === 'books');
                if (keyword.includes('ğŸµ') || keyword.includes('éŸ³ä¹') || keyword === 'music') return items.filter(item => item.category === 'music');
                
                return items.filter(item => 
                    item.name.toLowerCase().includes(keyword) || item.url.toLowerCase().includes(keyword)
                );
            }

            function renderSearchResults(results) {
                if (results.length === 0) {
                    searchResultsGrid.innerHTML = '<div class="empty-message">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®</div>';
                    return;
                }
                let html = '';
                results.forEach(item => {
                    const checked = selectedIds.has(item.id) ? 'checked' : '';
                    let domain = '';
                    try { domain = new URL(item.url).hostname; } catch { domain = item.url; }
                    let imageHtml = item.imageData ? `<img src="${item.imageData}">` : `<div style="width:100%;height:100%;background:#1a1a1a;display:flex;align-items:center;justify-content:center;color:#444;">â¬›</div>`;
                    html += `
                        <div class="search-card">
                            <input type="checkbox" class="search-card-checkbox" data-id="${item.id}" ${checked} onchange="window.toggleSelect('${item.id}')">
                            <div class="search-card-image" onclick="window.open('${item.url}', '_blank')">${imageHtml}</div>
                            <div class="search-card-info" onclick="window.open('${item.url}', '_blank')">
                                <div class="search-card-name">${item.name}</div>
                                <div class="search-card-url">${domain}</div>
                            </div>
                        </div>
                    `;
                });
                searchResultsGrid.innerHTML = html;
            }

            window.toggleSelect = (id) => {
                if (selectedIds.has(id)) selectedIds.delete(id);
                else selectedIds.add(id);
                refreshSearch();
            };

            function refreshSearch() {
                const keyword = searchInput.value;
                const results = getFilteredResults(keyword);
                renderSearchResults(results);
                searchHint.innerHTML = 'âœ¨ å…³é”®è¯æˆ–åˆ†åŒºå(ğŸ“±åº”ç”¨/ğŸ®æ¸¸æˆ/ğŸ¬ç”µå½±/ğŸ“˜å›¾ä¹¦/ğŸµéŸ³ä¹) å…¨å±€æœç´¢';
            }

            openSearchBtn.addEventListener('click', () => {
                searchOverlay.classList.add('show');
                searchInput.value = '';
                selectedIds.clear();
                refreshSearch();
                searchInput.focus();
            });

            closeSearchBtn.addEventListener('click', () => {
                searchOverlay.classList.remove('show');
            });

            searchInput.addEventListener('input', refreshSearch);

            selectAllBtn.addEventListener('click', () => {
                const keyword = searchInput.value;
                getFilteredResults(keyword).forEach(item => selectedIds.add(item.id));
                refreshSearch();
            });

            deselectAllBtn.addEventListener('click', () => {
                selectedIds.clear();
                refreshSearch();
            });

            // äº”è¿å¯¼å‡º
            function performFullExport() {
                if (items.length === 0) { alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º'); return; }

                let backupHTML = `<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>æ”¶è—å®Œæ•´å¤‡ä»½</title><style>
body{background:#111;color:#eee;font-family:sans-serif;padding:20px;max-width:600px;margin:0 auto;}
.item{border-bottom:1px solid #333;padding:10px 0;display:flex;gap:15px;align-items:center;}
img{width:50px;height:50px;border-radius:12px;object-fit:cover;}
.info{flex:1;}.cat{background:#2a2a2a;padding:2px 8px;border-radius:20px;font-size:0.7rem;display:inline-block;}
</style></head>
<body>
<h2>ğŸ“¦ å®Œæ•´æ”¶è—å¤‡ä»½ (å«å›¾ç‰‡/åˆ†ç±»)</h2>
<p>åˆ›å»ºæ—¶é—´: ${new Date().toLocaleString()}</p>
<p>é¡¹ç›®æ•°é‡: ${items.length}</p>
<div id="preview">`;
                
                items.forEach(item => {
                    let imgTag = item.imageData ? `<img src="${item.imageData}" />` : '<div style="width:50px;height:50px;background:#333;border-radius:12px;"></div>';
                    backupHTML += `<div class="item">${imgTag}<div class="info"><b>${item.name}</b> <span class="cat">${item.category}</span><br><small>${item.url}</small></div></div>`;
                });

                backupHTML += `</div><hr><p>ğŸ‘‡ å°†æ­¤æ–‡ä»¶å¯¼å…¥å³å¯æ¢å¤æ‰€æœ‰æ•°æ®</p>
<script>
window.__BACKUP_ITEMS = ${JSON.stringify(items)};
<\/script></body></html>`;

                const blob = new Blob([backupHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'å®Œæ•´æ”¶è—å¤‡ä»½_' + new Date().toISOString().slice(0,10) + '.html';
                a.click();
                URL.revokeObjectURL(url);
            }

            exportFullBtn.addEventListener('click', () => {
                exportClickCount++;
                if (exportTimer) clearTimeout(exportTimer);
                exportTimer = setTimeout(() => exportClickCount = 0, 3000);
                if (exportClickCount >= 5) {
                    performFullExport();
                    exportClickCount = 0;
                    if (exportTimer) { clearTimeout(exportTimer); exportTimer = null; }
                }
            });

            function performImport(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    let importedItems = [];

                    const backupMatch = content.match(/window\.__BACKUP_ITEMS\s*=\s*(\[[\s\S]*?\]);/);
                    if (backupMatch) {
                        try { importedItems = JSON.parse(backupMatch[1]); } catch (err) {}
                    }

                    if (importedItems.length === 0) {
                        const linkRegex = /<a\s+(?:[^>]*?\s+)?href="([^"]*)"[^>]*>(.*?)<\/a>/gi;
                        let match;
                        while ((match = linkRegex.exec(content)) !== null) {
                            let url = match[1].trim();
                            let text = match[2].replace(/<[^>]+>/g, '').trim();
                            if (!url || url.startsWith('#') || url.startsWith('javascript:') || url.startsWith('mailto:')) continue;
                            if (url.startsWith('//')) url = 'https:' + url;
                            else if (!url.match(/^https?:\/\//i)) continue;
                            let name = text || (() => { try { return new URL(url).hostname.replace('www.', ''); } catch { return url; } })();
                            importedItems.push({
                                name: name.substring(0, 50),
                                url: url,
                                category: currentCategory,
                                imageData: null
                            });
                        }
                    }

                    if (importedItems.length === 0) {
                        alert('æ–‡ä»¶ä¸­æœªæ‰¾åˆ°å¯å¯¼å…¥çš„ç½‘å€æˆ–å¤‡ä»½æ•°æ®');
                        return;
                    }

                    let added = 0, skipped = 0;
                    importedItems.forEach(imp => {
                        const exists = items.some(i => i.url === imp.url && i.name === imp.name);
                        if (!exists) {
                            items.push({
                                ...imp,
                                id: Date.now() + '-' + Math.random().toString(36).substr(2, 6) + '-' + added,
                                imageData: imp.imageData || null
                            });
                            added++;
                        } else skipped++;
                    });

                    if (added > 0) {
                        saveItems();
                        renderGrid();
                        alert(`å¯¼å…¥å®Œæˆï¼æ–°å¢ ${added} ä¸ªé¡¹ç›®ï¼Œè·³è¿‡ ${skipped} ä¸ªå·²å­˜åœ¨ã€‚`);
                    } else {
                        alert(`æ²¡æœ‰æ–°å¢é¡¹ç›® (å·²å­˜åœ¨ ${skipped} ä¸ª)`);
                    }
                    modal.classList.remove('show');
                };
                reader.readAsText(file, 'UTF-8');
            }

            importFromAddBtn.addEventListener('click', () => {
                const file = importFileInput.files[0];
                if (!file) { alert('è¯·å…ˆé€‰æ‹©HTMLæ–‡ä»¶'); return; }
                performImport(file);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });

            setActiveNav(currentCategory);
            renderGrid();

            window.editItem = editItem;
            window.editImage = editImage;
            window.deleteItem = deleteItem;
            window.toggleSelect = toggleSelect;
        })();
    </script>
</body>
</html>